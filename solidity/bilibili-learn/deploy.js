import { ethers } from "ethers";
import fs from "fs-extra";
// require("dotenv").config();
// bun install ganache -g
//  bun install ethers@5.6.3 fs-extra

// 使用abi和字节码部署合约
async function deploy(){
    // 连接rpc
    const provider = new ethers.providers.JsonRpcProvider("http://127.0.0.1:8545");
    // 连接钱包
    const wallet = new ethers.Wallet("0x56ff1c8357ae48738f39727492b306d70e5db950af125579a3d20001c5deadd0", provider);
    // 读取abi和字节码
    const abi = fs.readFileSync("./SimpleStorage.abi", "utf8");
    const binary = fs.readFileSync("./SimpleStorage.bin", "utf8");
    // 创建合约工厂
    const contractFactory = new ethers.ContractFactory(abi, binary, wallet);
    // 部署合约
    console.log("Contract deploying...");
    const deployedContract = await contractFactory.deploy({gasLimit: 1000000});
    // 等待交易确认
    const transactionReceipt = await deployedContract.deployTransaction.wait(1);
    // 返回交易receipt
    console.log("contract deployed at:", deployedContract.address);
    return JSON.stringify(transactionReceipt, null, 2);
}

// 使用字节码部署合约
const sendTransaction = async () => {
    // 连接rpc
    const provider = new ethers.providers.JsonRpcProvider("http://127.0.0.1:8545");
    // 连接钱包
    const wallet = new ethers.Wallet(process.env.PRIVATE_KEY, provider);
    // 获取nonce
    const nonce = await provider.getTransactionCount(wallet.address);
    console.log("nonce:", nonce);
    const tx = {
        nonce,
        gasPrice: ethers.parseUnits("2", "gwei"),
        gasLimit: 1000000,
        to: null,
        value: 0,
        data: "0x608060405234801561001057600080fd5b50610812806100206000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80636057361d1461005c5780636f760f41146100785780638bab8dd5146100945780639e7a13ad146100c4578063a6b7fc5b146100f5575b600080fd5b6100766004803603810190610071919061050e565b610113565b005b610092600480360381019061008d9190610465565b61011d565b005b6100ae60048036038101906100a991906104c5565b6101f4565b6040516100bb91906105f1565b60405180910390f35b6100de60048036038101906100d9919061050e565b610222565b6040516100ec9291906105c1565b60405180910390f35b6100fd6102de565b60405161010a91906105f1565b60405180910390f35b8060008190555050565b6002604051806040016040528085858080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050815260200183815250908060018154018082558091505060019003906000526020600020906002020160009091909190915060008201518160000190805190602001906101bd9291906102e7565b5060208201518160010155505080600184846040516101dd9291906105a8565b908152602001604051809103902081905550505050565b6001818051602081018201805184825260208301602085012081835280955050505050506000915090505481565b6002818154811061023257600080fd5b9060005260206000209060020201600091509050806000018054610255906106d5565b80601f0160208091040260200160405190810160405280929190818152602001828054610281906106d5565b80156102ce5780601f106102a3576101008083540402835291602001916102ce565b820191906000526020600020905b8154815290600101906020018083116102b157829003601f168201915b5050505050908060010154905082565b60008054905090565b8280546102f3906106d5565b90600052602060002090601f016020900481019282610315576000855561035c565b82601f1061032e57805160ff191683800117855561035c565b8280016001018555821561035c579182015b8281111561035b578251825591602001919060010190610340565b5b509050610369919061036d565b5090565b5b8082111561038657600081600090555060010161036e565b5090565b600061039d61039884610631565b61060c565b9050828152602081018484840111156103b9576103b86107a5565b5b6103c4848285610693565b509392505050565b60008083601f8401126103e2576103e161079b565b5b8235905067ffffffffffffffff8111156103ff576103fe610796565b5b60208301915083600182028301111561041b5761041a6107a0565b5b9250929050565b600082601f8301126104375761043661079b565b5b813561044784826020860161038a565b91505092915050565b60008135905061045f816107c5565b92915050565b60008060006040848603121561047e5761047d6107af565b5b600084013567ffffffffffffffff81111561049c5761049b6107aa565b5b6104a8868287016103cc565b935093505060206104bb86828701610450565b9150509250925092565b6000602082840312156104db576104da6107af565b5b600082013567ffffffffffffffff8111156104f9576104f86107aa565b5b61050584828501610422565b91505092915050565b600060208284031215610524576105236107af565b5b600061053284828501610450565b91505092915050565b6000610547838561067e565b9350610554838584610693565b82840190509392505050565b600061056b82610662565b610575818561066d565b93506105858185602086016106a2565b61058e816107b4565b840191505092915050565b6105a281610689565b82525050565b60006105b582848661053b565b91508190509392505050565b600060408201905081810360008301526105db8185610560565b90506105ea6020830184610599565b9392505050565b60006020820190506106066000830184610599565b92915050565b6000610616610627565b90506106228282610707565b919050565b6000604051905090565b600067ffffffffffffffff82111561064c5761064b610767565b5b610655826107b4565b9050602081019050919050565b600081519050919050565b600082825260208201905092915050565b600081905092915050565b6000819050919050565b82818337600083830152505050565b60005b838110156106c05780820151818401526020810190506106a5565b838111156106cf576000848401525b50505050565b600060028204905060018216806106ed57607f821691505b6020821081141561070157610700610738565b5b50919050565b610710826107b4565b810181811067ffffffffffffffff8211171561072f5761072e610767565b5b80604052505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b6000601f19601f8301169050919050565b6107ce81610689565b81146107d957600080fd5b5056fea26469706673582212209b99b29debc7b17a0050ae2515944d7dd9686d80b4384ffc23e49f8756dec7d764736f6c63430008070033",
        chainId: 1337,
    }
    const signedRawTransaction = await wallet.sendTransaction(tx);
    await signedRawTransaction.wait(1);
    console.log(signedRawTransaction);
    return signedRawTransaction;
}

deploy();
// sendTransaction();