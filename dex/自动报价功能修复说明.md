# è‡ªåŠ¨æŠ¥ä»·åŠŸèƒ½ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

**ç°è±¡**: Swap é¡µé¢è¾“å…¥ TokenA çš„æ•°é‡åï¼Œä¸ä¼šè‡ªåŠ¨è®¡ç®—å‡º TokenB çš„æ•°é‡

## ğŸ” é—®é¢˜æ ¹æº

### åŸä»£ç çš„é—®é¢˜

```typescript
// âŒ é—®é¢˜ä»£ç 
const getQuote = async (amount: string) => {
  // ... æŠ¥ä»·é€»è¾‘
}

useEffect(() => {
  const timer = setTimeout(() => {
    if (amountIn) {
      getQuote(amountIn)
    }
  }, 500)
  return () => clearTimeout(timer)
}, [amountIn, tokenIn, tokenOut, selectedFee])
//  â†‘ ä¾èµ–äº†å¯¹è±¡ï¼Œä½†æ²¡æœ‰åŒ…å« getQuote å‡½æ•°
```

### é—®é¢˜åˆ†æ

1. **`getQuote` å‡½æ•°æ¯æ¬¡æ¸²æŸ“éƒ½é‡æ–°åˆ›å»º**

   - æ²¡æœ‰ä½¿ç”¨ `useCallback` åŒ…è£¹
   - æ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯æ–°çš„å‡½æ•°å¼•ç”¨

2. **`useEffect` çš„ä¾èµ–é—®é¢˜**

   - ä¾èµ–äº† `tokenIn`, `tokenOut`, `selectedFee` å¯¹è±¡
   - è¿™äº›å¯¹è±¡å¼•ç”¨å¯èƒ½ä¸ç¨³å®š
   - æ²¡æœ‰åŒ…å« `getQuote` å‡½æ•°ï¼ˆé—­åŒ…é™·é˜±ï¼‰
   - å¯èƒ½è°ƒç”¨çš„æ˜¯æ—§çš„ `getQuote` å‡½æ•°

3. **`swapRouter` ä¾èµ–é—®é¢˜**
   - `getQuote` å†…éƒ¨ä½¿ç”¨äº† `swapRouter`
   - ä½† `swapRouter` å¯èƒ½åœ¨æ¸²æŸ“æ—¶è¿˜æœªå‡†å¤‡å¥½
   - æ²¡æœ‰æ­£ç¡®å¤„ç†å¼‚æ­¥åŠ è½½

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. ä½¿ç”¨ `useCallback` ç¨³å®š `getQuote` å‡½æ•°

```typescript
// âœ… ä¿®å¤å
const getQuote = useCallback(
  async (amount: string) => {
    if (!amount || parseFloat(amount) <= 0) {
      setAmountOut("")
      return
    }

    const router = swapRouterRef.current
    if (!router) {
      console.log("â³ Swap router not ready")
      return
    }

    setQuoteLoading(true)
    try {
      const amountInWei = parseUnits(amount, 18)

      const quote = await router.quoteExactInput({
        tokenIn: tokenIn.address,
        tokenOut: tokenOut.address,
        indexPath: [selectedFee.index],
        amountIn: amountInWei,
        sqrtPriceLimitX96: 0
      })

      setAmountOut(formatUnits(quote, 18))
    } catch (error) {
      console.error("âŒ Error getting quote:", error)
      setAmountOut("")
    } finally {
      setQuoteLoading(false)
    }
  },
  [tokenIn.address, tokenIn.symbol, tokenOut.address, tokenOut.symbol, selectedFee.index, selectedFee.label]
)
// âœ… åªä¾èµ–åŸºæœ¬ç±»å‹ï¼ˆstring, numberï¼‰
```

**å…³é”®ç‚¹**:

- ä½¿ç”¨ `useCallback` åŒ…è£¹ï¼Œåªåœ¨ä¾èµ–å˜åŒ–æ—¶é‡æ–°åˆ›å»º
- åªä¾èµ–åŸºæœ¬ç±»å‹ï¼š`tokenIn.address`, `tokenOut.address`, `selectedFee.index` ç­‰
- ä¸ä¾èµ–å¯¹è±¡å¼•ç”¨

### 2. ä½¿ç”¨ `useRef` ä¿å­˜ `swapRouter`

```typescript
// ä½¿ç”¨ useRef ä¿å­˜ swapRouterï¼Œé¿å…ä¾èµ–é—®é¢˜
const swapRouterRef = useRef(swapRouter)
swapRouterRef.current = swapRouter

const getQuote = useCallback(
  async (amount: string) => {
    // ä» ref ä¸­è·å–æœ€æ–°çš„ router
    const router = swapRouterRef.current
    if (!router) {
      return
    }
    // ... ä½¿ç”¨ router
  },
  [tokenIn.address, tokenOut.address, selectedFee.index]
)
// âœ… ä¸éœ€è¦ä¾èµ– swapRouter
```

**å…³é”®ç‚¹**:

- `swapRouter` é€šè¿‡ `useRef` è®¿é—®ï¼Œä¸ä½œä¸ºä¾èµ–
- é¿å…å›  `swapRouter` å¼•ç”¨å˜åŒ–å¯¼è‡´ `getQuote` é‡æ–°åˆ›å»º

### 3. ä¿®å¤ `useEffect` ä¾èµ–

```typescript
// âœ… ä¿®å¤åçš„ useEffect
useEffect(() => {
  const timer = setTimeout(() => {
    if (amountIn) {
      console.log("ğŸ”„ Input changed, getting quote for:", amountIn)
      getQuote(amountIn)
    } else {
      setAmountOut("")
    }
  }, 500) // é˜²æŠ– 500ms

  return () => clearTimeout(timer)
}, [amountIn, getQuote])
// âœ… åªä¾èµ– amountIn å’Œç¨³å®šçš„ getQuote å‡½æ•°
```

**å…³é”®ç‚¹**:

- åªä¾èµ– `[amountIn, getQuote]`
- `getQuote` ç°åœ¨æ˜¯ç¨³å®šçš„ï¼ˆé€šè¿‡ `useCallback`ï¼‰
- ä¸å†ä¾èµ–å¯¹è±¡ `tokenIn`, `tokenOut`, `selectedFee`
- è¿™äº›å˜åŒ–å·²ç»åœ¨ `getQuote` çš„ä¾èµ–ä¸­å¤„ç†äº†

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰

```
ç”¨æˆ·è¾“å…¥ "100"
â†’ amountIn æ”¹å˜
â†’ useEffect è§¦å‘
â†’ è°ƒç”¨ getQuote(amountIn)
â†’ ä½† getQuote å¯èƒ½æ˜¯æ—§çš„å‡½æ•°ï¼ˆé—­åŒ…é—®é¢˜ï¼‰
â†’ æˆ–è€… swapRouter è¿˜æœªå‡†å¤‡å¥½
â†’ âŒ æ²¡æœ‰è¾“å‡º TokenB çš„æ•°é‡
```

### ä¿®å¤å

```
ç”¨æˆ·è¾“å…¥ "100"
â†’ amountIn æ”¹å˜
â†’ useEffect è§¦å‘ï¼ˆ500ms é˜²æŠ–ï¼‰
â†’ è°ƒç”¨æœ€æ–°çš„ getQuote(amountIn)
â†’ getQuote ä» ref è·å–æœ€æ–°çš„ swapRouter
â†’ è°ƒç”¨åˆçº¦çš„ quoteExactInput
â†’ âœ… æˆåŠŸè·å–æŠ¥ä»·å¹¶æ˜¾ç¤º TokenB çš„æ•°é‡

æ§åˆ¶å°æ—¥å¿—ï¼š
ğŸ”„ Input changed, getting quote for: 100
ğŸ’° Getting quote... { tokenIn: "MNA", tokenOut: "MNB", ... }
âœ… Quote received: 95.5
```

## ğŸ¯ å·¥ä½œæµç¨‹

### å®Œæ•´çš„è‡ªåŠ¨æŠ¥ä»·æµç¨‹

```
1. ç”¨æˆ·åœ¨è¾“å…¥æ¡†è¾“å…¥æ•°é‡
   â†“
2. amountIn çŠ¶æ€æ”¹å˜
   â†“
3. useEffect æ£€æµ‹åˆ° amountIn å˜åŒ–
   â†“
4. å¯åŠ¨ 500ms é˜²æŠ–è®¡æ—¶å™¨
   â†“
5. è®¡æ—¶å™¨ç»“æŸåè°ƒç”¨ getQuote(amountIn)
   â†“
6. getQuote å‡½æ•°æ‰§è¡Œï¼š
   a. æ£€æŸ¥ amountIn æ˜¯å¦æœ‰æ•ˆ
   b. ä» swapRouterRef è·å–æœ€æ–°çš„ router
   c. è½¬æ¢é‡‘é¢ä¸º Wei å•ä½
   d. è°ƒç”¨ router.quoteExactInput()
   e. è·å–æŠ¥ä»·å¹¶æ ¼å¼åŒ–
   â†“
7. setAmountOut(æŠ¥ä»·ç»“æœ)
   â†“
8. âœ… é¡µé¢æ˜¾ç¤º TokenB çš„æ•°é‡
```

### è§¦å‘è‡ªåŠ¨æŠ¥ä»·çš„åœºæ™¯

1. **ç”¨æˆ·è¾“å…¥é‡‘é¢**

   - è¾“å…¥æ¡†å€¼æ”¹å˜ â†’ `amountIn` å˜åŒ– â†’ è§¦å‘æŠ¥ä»·

2. **åˆ‡æ¢ä»£å¸**

   - é€‰æ‹©ä¸åŒçš„ TokenIn/TokenOut â†’ `getQuote` é‡æ–°åˆ›å»º â†’ è§¦å‘æŠ¥ä»·

3. **åˆ‡æ¢è´¹ç‡**

   - é€‰æ‹©ä¸åŒçš„è´¹ç‡ â†’ `getQuote` é‡æ–°åˆ›å»º â†’ è§¦å‘æŠ¥ä»·

4. **ç‚¹å‡» MAX æŒ‰é’®**
   - è®¾ç½®æœ€å¤§é‡‘é¢ â†’ `amountIn` å˜åŒ– â†’ è§¦å‘æŠ¥ä»·

## ğŸ” è°ƒè¯•æ—¥å¿—

### æ­£å¸¸æƒ…å†µ

æ‰“å¼€æ§åˆ¶å°ï¼ˆF12ï¼‰ï¼Œè¾“å…¥é‡‘é¢ååº”è¯¥çœ‹åˆ°ï¼š

```
ğŸ”„ Input changed, getting quote for: 100
ğŸ’° Getting quote... {
  tokenIn: "MNA",
  tokenOut: "MNB",
  amountIn: "100",
  fee: "0.30%"
}
âœ… Quote received: 95.5
```

### å¼‚å¸¸æƒ…å†µ

#### 1. Router æœªå‡†å¤‡å¥½

```
ğŸ”„ Input changed, getting quote for: 100
â³ Swap router not ready
```

**è§£å†³**: ç­‰å¾…å‡ ç§’é’Ÿï¼Œæˆ–åˆ·æ–°é¡µé¢

#### 2. åˆçº¦è°ƒç”¨å¤±è´¥

```
ğŸ”„ Input changed, getting quote for: 100
ğŸ’° Getting quote...
âŒ Error getting quote: Error: execution reverted
```

**å¯èƒ½åŸå› **:

- æµåŠ¨æ€§æ± ä¸å­˜åœ¨
- è¯¥è´¹ç‡å±‚çº§æ²¡æœ‰æµåŠ¨æ€§
- ç½‘ç»œé—®é¢˜

## âœ… æµ‹è¯•æ¸…å•

- [ ] è¾“å…¥é‡‘é¢åï¼Œç­‰å¾… 500msï¼Œè‡ªåŠ¨æ˜¾ç¤ºè¾“å‡ºé‡‘é¢
- [ ] åˆ‡æ¢ TokenInï¼Œè‡ªåŠ¨é‡æ–°è®¡ç®—æŠ¥ä»·
- [ ] åˆ‡æ¢ TokenOutï¼Œè‡ªåŠ¨é‡æ–°è®¡ç®—æŠ¥ä»·
- [ ] åˆ‡æ¢è´¹ç‡ï¼Œè‡ªåŠ¨é‡æ–°è®¡ç®—æŠ¥ä»·
- [ ] ç‚¹å‡» MAX æŒ‰é’®ï¼Œè‡ªåŠ¨è®¡ç®—æŠ¥ä»·
- [ ] æ¸…ç©ºè¾“å…¥ï¼Œè¾“å‡ºé‡‘é¢ä¹Ÿæ¸…ç©º
- [ ] æ§åˆ¶å°æœ‰æ¸…æ™°çš„æ—¥å¿—
- [ ] é˜²æŠ–åŠŸèƒ½æ­£å¸¸ï¼ˆå¿«é€Ÿè¾“å…¥ä¸ä¼šè§¦å‘å¤šæ¬¡ï¼‰

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### 1. React Hooks é˜²æŠ–æ¨¡å¼

```typescript
useEffect(() => {
  const timer = setTimeout(() => {
    // æ‰§è¡Œæ“ä½œ
  }, 500)

  return () => clearTimeout(timer) // æ¸…ç†å®šæ—¶å™¨
}, [dependency])
```

### 2. useCallback ä¸ useRef ç»„åˆ

```typescript
// ä¿å­˜å¯¹è±¡å¼•ç”¨
const objectRef = useRef(object)
objectRef.current = object

// ç¨³å®šçš„å›è°ƒå‡½æ•°
const callback = useCallback(() => {
  const obj = objectRef.current // è®¿é—®æœ€æ–°å€¼
  // ... ä½¿ç”¨ obj
}, [id, name]) // åªä¾èµ–åŸºæœ¬ç±»å‹
```

### 3. å¼‚æ­¥çŠ¶æ€ç®¡ç†

```typescript
const [loading, setLoading] = useState(false)

const fetchData = async () => {
  setLoading(true)
  try {
    const data = await api.fetch()
    setData(data)
  } catch (error) {
    console.error(error)
  } finally {
    setLoading(false) // ç¡®ä¿æ€»æ˜¯é‡ç½® loading
  }
}
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `web/src/components/Swap.tsx` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶
- `web/src/hooks/useContract.ts` - `useSwapRouter` Hook
- `web/src/config/abis.ts` - SwapRouter ABIï¼ˆåŒ…å« `quoteExactInput` æ–¹æ³•ï¼‰

---

**ä¿®å¤å®Œæˆ**: 2025-10-23  
**é—®é¢˜ç±»å‹**: React Hooks é—­åŒ…é—®é¢˜ + ä¾èµ–ç®¡ç†  
**ä¿®å¤éš¾åº¦**: â­â­â­ (ä¸­ç­‰)  
**ç”¨æˆ·ä½“éªŒæå‡**: â­â­â­â­â­ (éå¸¸é«˜)
