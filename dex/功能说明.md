# MetaNodeSwap 前端功能说明

## 📋 目录

1. [项目概述](#项目概述)
2. [核心功能](#核心功能)
3. [新增功能](#新增功能)
4. [技术架构](#技术架构)
5. [使用指南](#使用指南)

---

## 项目概述

MetaNodeSwap 是一个基于 UniswapV3 简化版本的去中心化交易所前端应用，部署在 Sepolia 测试网络。

### 特点

- 🎨 现代化 UI 设计
- 🔄 实时交易报价
- 💰 流动性管理
- 📊 持仓可视化
- ⚡ 快速响应

---

## 核心功能

### 1. Swap (代币交换)

**功能描述**

- 支持任意 ERC20 代币之间的交换
- 实时价格计算
- 自动报价更新
- 滑点保护 (默认 5%)

**新增：费率选择** ⭐

```
┌─────────────────────────────────┐
│  Fee Tier                       │
│  ┌───────┐ ┌───────┐ ┌───────┐ │
│  │ 0.05% │ │ 0.30% │ │ 1.00% │ │
│  └───────┘ └───────┘ └───────┘ │
└─────────────────────────────────┘
```

**使用流程**

1. 选择费率 (0.05%, 0.30%, 1.00%)
2. 选择输入/输出代币
3. 输入交换数量
4. 查看预期输出
5. 授权代币
6. 执行交换

### 2. Liquidity (流动性管理)

**功能描述**

- 添加流动性赚取手续费
- 双代币同时提供
- 自动计算比例

**新增：费率选择** ⭐

- 选择想要提供流动性的费率池
- 不同费率对应不同收益率
- 高费率 = 高波动 = 高收益

**使用流程**

1. 选择费率层级
2. 选择代币对
3. 输入两种代币数量
4. 授权两个代币
5. 添加流动性

### 3. Positions (持仓管理)

**功能描述**

- 查看所有流动性持仓
- 显示详细持仓信息
- 收取手续费收益
- 移除流动性

**显示信息**

- Position ID
- 代币对地址
- 流动性数量
- Tick 范围
- 已赚取手续费
- 费率标签

**操作**

- Collect Fees - 提取手续费
- Remove Liquidity - 移除流动性
- Refresh - 刷新列表

---

## 新增功能

### ⭐ 费率选择功能

#### 实现位置

1. **Swap.tsx** - 交换页面
2. **Liquidity.tsx** - 流动性页面

#### 费率选项

```typescript
const FEE_TIERS = [
  { label: "0.05%", value: 500, index: 0 }, // 稳定币对
  { label: "0.30%", value: 3000, index: 1 }, // 标准费率（默认）
  { label: "1.00%", value: 10000, index: 2 } // 高波动对
]
```

#### 界面设计

- 三个按钮横向排列
- 选中状态：渐变背景 + 白色文字
- 未选中：深色背景 + 灰色边框
- 悬停效果：紫色边框高亮

#### 交互逻辑

```javascript
// Swap 页面
- 切换费率 → 自动重新获取报价
- 使用选中费率的 index 参数

// Liquidity 页面
- 切换费率 → 切换目标流动性池
- 添加到对应费率的池子
```

### 🔧 钱包连接修复

#### 问题

点击 "Connect Wallet" 按钮无响应

#### 原因分析

1. 缺少错误处理
2. 没有异步等待
3. 未检查 connector 可用性

#### 解决方案

```typescript
const handleConnect = async () => {
  try {
    const injectedConnector = connectors.find((c) => c.id === "injected")
    if (injectedConnector) {
      await connect({ connector: injectedConnector })
    } else {
      alert("Please install MetaMask or another Web3 wallet")
    }
  } catch (err) {
    console.error("Failed to connect:", err)
    alert("Failed to connect wallet. Please try again.")
  }
}
```

#### 改进点

- ✅ 异步处理
- ✅ 错误捕获
- ✅ 用户提示
- ✅ 控制台日志

---

## 技术架构

### 前端技术栈

```
├── React 18          - UI 框架
├── TypeScript        - 类型安全
├── Vite             - 构建工具
├── Wagmi v2         - 以太坊 Hooks
├── Ethers.js v6     - 区块链交互
└── React Router     - 路由管理
```

### 项目结构

```
web/
├── src/
│   ├── components/       # React 组件
│   │   ├── Header.tsx    # 导航头部
│   │   ├── Swap.tsx      # 交换界面 ⭐
│   │   ├── Liquidity.tsx # 流动性界面 ⭐
│   │   └── Positions.tsx # 持仓界面
│   ├── config/           # 配置文件
│   │   ├── contracts.ts  # 合约地址
│   │   ├── abis.ts       # 合约 ABI
│   │   └── wagmi.ts      # Web3 配置
│   ├── hooks/            # 自定义 Hooks
│   │   ├── useContract.ts
│   │   └── useTokenBalance.ts
│   ├── App.tsx           # 主应用
│   └── App.css           # 样式文件 ⭐
```

### 合约集成

```typescript
// SwapRouter - 交换路由
interface ExactInputParams {
  tokenIn: address
  tokenOut: address
  indexPath: uint32[] // ⭐ 费率索引
  recipient: address
  deadline: uint256
  amountIn: uint256
  amountOutMinimum: uint256
  sqrtPriceLimitX96: uint160
}

// PositionManager - 持仓管理
interface MintParams {
  token0: address
  token1: address
  index: uint32 // ⭐ 费率索引
  amount0Desired: uint256
  amount1Desired: uint256
  recipient: address
  deadline: uint256
}
```

---

## 使用指南

### 环境准备

1. **安装钱包**

   ```
   下载 MetaMask 浏览器插件
   https://metamask.io/
   ```

2. **切换网络**

   ```
   网络：Sepolia Testnet
   Chain ID: 11155111
   ```

3. **获取测试币**
   ```
   Sepolia ETH 水龙头
   https://sepoliafaucet.com/
   ```

### 快速开始

1. **启动应用**

   ```bash
   cd web
   pnpm install
   pnpm dev
   ```

2. **连接钱包**

   - 点击右上角 "Connect Wallet"
   - 在 MetaMask 中授权

3. **开始交易**
   - 选择费率
   - 选择代币对
   - 输入数量
   - 授权并交换

### 费率选择建议

#### 0.05% - 低费率

- **适用场景**：稳定币交易对 (如 USDC/USDT)
- **特点**：低滑点，低手续费
- **流动性提供者**：收益低但稳定

#### 0.30% - 标准费率 (推荐)

- **适用场景**：大多数交易对
- **特点**：平衡的费率和流动性
- **流动性提供者**：适中收益

#### 1.00% - 高费率

- **适用场景**：高波动性代币对
- **特点**：高手续费补偿无常损失
- **流动性提供者**：高风险高收益

---

## 常见问题

### Q1: 如何选择合适的费率？

**A:**

- **稳定币交易** → 选择 0.05%
- **主流币交易** → 选择 0.30%
- **小币种交易** → 选择 1.00%

### Q2: 为什么切换费率后没有报价？

**A:**
可能原因：

1. 该费率池子不存在
2. 池子没有流动性
3. 网络延迟

解决方法：

- 尝试其他费率
- 检查是否有该交易对的池子
- 刷新页面重试

### Q3: 钱包连接后还是无法交易？

**A:**
检查清单：

- ✅ 是否在 Sepolia 网络
- ✅ 是否有足够的 ETH (Gas 费)
- ✅ 是否有足够的代币余额
- ✅ 是否已授权代币

### Q4: 如何获取测试代币？

**A:**

1. 先获取 Sepolia ETH
2. 使用测试代币合约铸造
3. 或联系项目方获取

---

## 技术支持

遇到问题？

1. 查看浏览器控制台错误
2. 检查 MetaMask 钱包配置
3. 阅读 README.md
4. 查看 CHANGELOG.md

---

## 更新计划

未来可能增加：

- [ ] 多跳路由优化
- [ ] 价格图表
- [ ] 交易历史记录
- [ ] 更多代币支持
- [ ] 移动端适配
- [ ] 深色/浅色主题切换

---

**版本**: v1.0.0  
**最后更新**: 2025-10-22  
**网络**: Sepolia Testnet
