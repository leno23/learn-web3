# Swap æŠ¥ä»·åŠŸèƒ½ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

### é—®é¢˜ 1: Contract Runner é”™è¯¯

åœ¨ Swap é¡µé¢è¾“å…¥ TokenA æ•°é‡åï¼Œè·å–æŠ¥ä»·æ—¶å‡ºç°é”™è¯¯ï¼š

```
Error getting quote: Error: contract runner does not support sending transactions
(operation="sendTransaction", code=UNSUPPORTED_OPERATION, version=6.15.0)
```

### é—®é¢˜ 2: SPL (Sqrt Price Limit) é”™è¯¯

ä¿®å¤é—®é¢˜ 1 åï¼Œåˆå‡ºç°æ–°çš„é”™è¯¯ï¼š

```
Error: execution reverted: "SPL"
```

## ğŸ” é—®é¢˜åŸå› 

### é—®é¢˜ 1 åŸå› 

åœ¨ **ethers.js v6** ä¸­ï¼Œå½“åˆçº¦å®ä¾‹ä½¿ç”¨ `signer` åˆ›å»ºæ—¶ï¼Œç›´æ¥è°ƒç”¨åˆçº¦æ–¹æ³•ä¼šè¢«è¯†åˆ«ä¸º**å‘é€äº¤æ˜“**ï¼Œå³ä½¿è¯¥æ–¹æ³•æ˜¯ `view` æˆ– `pure` å‡½æ•°ï¼ˆåªè¯»å‡½æ•°ï¼‰ã€‚

åŸä»£ç ï¼š

```typescript
// âŒ é”™è¯¯ï¼šä¼šå°è¯•å‘é€äº¤æ˜“
const quote = await router.quoteExactInput({
  tokenIn: tokenIn.address,
  tokenOut: tokenOut.address,
  indexPath: [selectedFeeTier?.index ?? 1],
  amountIn: amountInWei,
  sqrtPriceLimitX96: 0
})
```

### é—®é¢˜ 2 åŸå› 

åœ¨ Pool åˆçº¦ä¸­ï¼Œæœ‰ä¸€ä¸ªä»·æ ¼é™åˆ¶æ£€æŸ¥ï¼š

```solidity
require(
    zeroForOne
        ? sqrtPriceLimitX96 < sqrtPriceX96 && sqrtPriceLimitX96 > TickMath.MIN_SQRT_PRICE
        : sqrtPriceLimitX96 > sqrtPriceX96 && sqrtPriceLimitX96 < TickMath.MAX_SQRT_PRICE,
    "SPL"  // Sqrt Price Limit error
);
```

å½“ `sqrtPriceLimitX96 = 0` æ—¶ï¼š

- **å¦‚æœ zeroForOne ä¸º true**: éœ€è¦ `0 > MIN_SQRT_PRICE`ï¼Œæ°¸è¿œä¸º false
- **å¦‚æœ zeroForOne ä¸º false**: éœ€è¦ `0 < MAX_SQRT_PRICE`ï¼Œè™½ç„¶ä¸º trueï¼Œä½† `0 > sqrtPriceX96` ä¸º false

æ‰€ä»¥è®¾ç½®ä¸º `0` æ—¶ä¼šå¯¼è‡´ä»·æ ¼æ£€æŸ¥å¤±è´¥ï¼

## âœ… è§£å†³æ–¹æ¡ˆ

### è§£å†³æ–¹æ¡ˆ 1: ä½¿ç”¨ staticCall

ä½¿ç”¨ `.staticCall` æ–¹æ³•æ˜ç¡®æŒ‡å®šè¿™æ˜¯ä¸€ä¸ª**åªè¯»è°ƒç”¨**ï¼ˆä¸ä¿®æ”¹åŒºå—é“¾çŠ¶æ€ï¼‰ï¼š

```typescript
// âœ… ä½¿ç”¨ staticCall è¿›è¡Œåªè¯»è°ƒç”¨
const quote = await router.quoteExactInput.staticCall({
  ...params
})
```

### è§£å†³æ–¹æ¡ˆ 2: è®¾ç½®æ­£ç¡®çš„ä»·æ ¼é™åˆ¶

æ ¹æ®ä»£å¸åœ°å€å¤§å°å…³ç³»è®¡ç®— `zeroForOne`ï¼Œç„¶åè®¾ç½®æ­£ç¡®çš„ `sqrtPriceLimitX96`ï¼š

```typescript
// è®¡ç®— zeroForOne (token åœ°å€æ¯”è¾ƒå¤§å°)
const zeroForOne = tokenIn.address.toLowerCase() < tokenOut.address.toLowerCase()

// è®¾ç½®ä»·æ ¼é™åˆ¶ï¼šä¸é™åˆ¶ä»·æ ¼æ—¶ä½¿ç”¨æé™å€¼
// MIN_SQRT_PRICE = 4295128739
// MAX_SQRT_PRICE = 1461446703485210103287273052203988822378723970342
const sqrtPriceLimitX96 = zeroForOne
  ? BigInt("4295128740") // MIN_SQRT_PRICE + 1
  : BigInt("1461446703485210103287273052203988822378723970341") // MAX_SQRT_PRICE - 1

const quote = await router.quoteExactInput.staticCall({
  tokenIn: tokenIn.address,
  tokenOut: tokenOut.address,
  indexPath: [selectedFeeTier?.index ?? 1],
  amountIn: amountInWei,
  sqrtPriceLimitX96: sqrtPriceLimitX96 // âœ… ä½¿ç”¨æ­£ç¡®çš„ä»·æ ¼é™åˆ¶
})
```

## ğŸ“š æŠ€æœ¯èƒŒæ™¯

### ethers.js v6 çš„è°ƒç”¨æ–¹å¼

åœ¨ ethers.js v6 ä¸­ï¼Œåˆçº¦æ–¹æ³•è°ƒç”¨æœ‰ä¸‰ç§æ–¹å¼ï¼š

1. **æ™®é€šè°ƒç”¨**ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰

   ```typescript
   await contract.someMethod(params)
   ```

   - å¦‚æœåˆçº¦æœ‰ `signer`ï¼šå‘é€äº¤æ˜“ï¼ˆä¿®æ”¹çŠ¶æ€ï¼‰
   - å¦‚æœåˆçº¦åªæœ‰ `provider`ï¼šåªè¯»è°ƒç”¨

2. **staticCall**ï¼ˆå¼ºåˆ¶åªè¯»ï¼‰

   ```typescript
   await contract.someMethod.staticCall(params)
   ```

   - æ€»æ˜¯è¿›è¡Œåªè¯»è°ƒç”¨ï¼Œä¸ä¿®æ”¹çŠ¶æ€
   - é€‚ç”¨äº `view` å’Œ `pure` å‡½æ•°
   - **æ¨èç”¨äºè·å–æ•°æ®çš„åœºæ™¯**

3. **estimateGas**ï¼ˆä¼°ç®— gasï¼‰
   ```typescript
   await contract.someMethod.estimateGas(params)
   ```
   - ä¼°ç®—æ‰§è¡Œäº¤æ˜“æ‰€éœ€çš„ gas
   - ä¸ä¼šå®é™…å‘é€äº¤æ˜“

### ä¸ºä»€ä¹ˆéœ€è¦ staticCallï¼Ÿ

åœ¨ Swap ç»„ä»¶ä¸­ï¼š

- `useSwapRouter()` è¿”å›çš„åˆçº¦å®ä¾‹ä¼˜å…ˆä½¿ç”¨ `signer`ï¼ˆç”¨äºåç»­çš„å®é™…äº¤æ¢äº¤æ˜“ï¼‰
- `quoteExactInput` æ˜¯ä¸€ä¸ª `view` å‡½æ•°ï¼Œåªç”¨äºè·å–æŠ¥ä»·ï¼Œä¸åº”è¯¥å‘é€äº¤æ˜“
- å¦‚æœä¸ä½¿ç”¨ `.staticCall`ï¼Œethers ä¼šå°è¯•å‘é€äº¤æ˜“ï¼Œå¯¼è‡´é”™è¯¯

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

- âœ… `web/src/components/Swap.tsx` - ç¬¬ 91-145 è¡Œï¼ˆgetQuote å‡½æ•°ï¼‰
- âœ… `web/src/components/Swap.tsx` - ç¬¬ 187-255 è¡Œï¼ˆhandleSwap å‡½æ•°ï¼‰

### ä¿®æ”¹å†…å®¹

#### 1. getQuote å‡½æ•°

```diff
+ // è®¡ç®— zeroForOne (token åœ°å€æ¯”è¾ƒå¤§å°)
+ const zeroForOne = tokenIn.address.toLowerCase() < tokenOut.address.toLowerCase();
+
+ // è®¾ç½®ä»·æ ¼é™åˆ¶
+ const sqrtPriceLimitX96 = zeroForOne
+   ? BigInt('4295128740')  // MIN_SQRT_PRICE + 1
+   : BigInt('1461446703485210103287273052203988822378723970341');  // MAX_SQRT_PRICE - 1

- const quote = await router.quoteExactInput({
+ const quote = await router.quoteExactInput.staticCall({
    tokenIn: tokenIn.address,
    tokenOut: tokenOut.address,
    indexPath: [selectedFeeTier?.index ?? 1],
    amountIn: amountInWei,
-   sqrtPriceLimitX96: 0,
+   sqrtPriceLimitX96: sqrtPriceLimitX96,
  });
```

#### 2. handleSwap å‡½æ•°

```diff
+ // è®¡ç®— zeroForOne
+ const zeroForOne = tokenIn.address.toLowerCase() < tokenOut.address.toLowerCase();
+
+ // è®¾ç½®ä»·æ ¼é™åˆ¶
+ const sqrtPriceLimitX96 = zeroForOne
+   ? BigInt('4295128740')
+   : BigInt('1461446703485210103287273052203988822378723970341');

  const tx = await swapRouter.exactInput({
    tokenIn: tokenIn.address,
    tokenOut: tokenOut.address,
    indexPath: [selectedFeeTier?.index ?? 1],
    recipient: address,
    deadline: deadline,
    amountIn: amountInWei,
    amountOutMinimum: amountOutMin,
-   sqrtPriceLimitX96: 0,
+   sqrtPriceLimitX96: sqrtPriceLimitX96,
  });
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

- âœ… è¾“å…¥é‡‘é¢åå¯ä»¥æ­£å¸¸è·å–æŠ¥ä»·
- âœ… ä¸ä¼šå°è¯•å‘é€äº¤æ˜“ï¼ˆä½¿ç”¨ staticCallï¼‰
- âœ… åªè¯»è°ƒç”¨ï¼Œä¸æ¶ˆè€— gas
- âœ… ä»·æ ¼é™åˆ¶æ£€æŸ¥é€šè¿‡ï¼ˆä½¿ç”¨æ­£ç¡®çš„ sqrtPriceLimitX96ï¼‰
- âœ… å“åº”é€Ÿåº¦å¿«
- âœ… å®é™… Swap äº¤æ˜“ä¹Ÿèƒ½æ­£å¸¸æ‰§è¡Œ

## ğŸ”„ å…¶ä»–å¯èƒ½éœ€è¦ staticCall çš„åœºæ™¯

åœ¨é¡¹ç›®ä¸­ï¼Œä»¥ä¸‹åœºæ™¯ä¹Ÿåº”è¯¥ä½¿ç”¨ `.staticCall`ï¼š

1. **è·å–æ± å­ä¿¡æ¯**

   ```typescript
   const poolInfo = await poolManager.getPool.staticCall(token0, token1, fee)
   ```

2. **è®¡ç®—æµåŠ¨æ€§**

   ```typescript
   const liquidity = await positionManager.calculateLiquidity.staticCall(params)
   ```

3. **æŸ¥è¯¢ä½™é¢**ï¼ˆå¦‚æœä½¿ç”¨ signer çš„åˆçº¦å®ä¾‹ï¼‰
   ```typescript
   const balance = await tokenContract.balanceOf.staticCall(address)
   ```

## ğŸ’¡ æœ€ä½³å®è·µ

### æ–¹æ¡ˆ 1: ä½¿ç”¨ staticCallï¼ˆæ¨èï¼‰

```typescript
// å¯¹äºåªè¯»æ“ä½œï¼Œæ˜ç¡®ä½¿ç”¨ staticCall
const result = await contract.viewFunction.staticCall(params)
```

**ä¼˜ç‚¹ï¼š**

- æ˜ç¡®è¯­ä¹‰ï¼Œä»£ç å¯è¯»æ€§å¥½
- ä¸ä¼šæ„å¤–å‘é€äº¤æ˜“
- å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªåˆçº¦å®ä¾‹

### æ–¹æ¡ˆ 2: åˆ†ç¦»åªè¯»å’Œå†™å…¥åˆçº¦

```typescript
// åˆ›å»ºä¸¤ä¸ªåˆçº¦å®ä¾‹
const readOnlyContract = new Contract(address, abi, provider) // åªè¯»
const writableContract = new Contract(address, abi, signer) // å†™å…¥

// åªè¯»æ“ä½œ
const result = await readOnlyContract.viewFunction(params)

// å†™å…¥æ“ä½œ
const tx = await writableContract.writeFunction(params)
```

**ä¼˜ç‚¹ï¼š**

- åˆ†ç¦»å…³æ³¨ç‚¹
- é˜²æ­¢è¯¯æ“ä½œ

**ç¼ºç‚¹ï¼š**

- éœ€è¦ç»´æŠ¤ä¸¤ä¸ªå®ä¾‹
- å ç”¨æ›´å¤šå†…å­˜

## ğŸš€ éªŒè¯

è¿è¡Œé¡¹ç›®å¹¶æµ‹è¯•ï¼š

```bash
cd web
pnpm dev
```

æµ‹è¯•æ­¥éª¤ï¼š

1. æ‰“å¼€ Swap é¡µé¢
2. è¾“å…¥ TokenA æ•°é‡ï¼ˆä¾‹å¦‚ï¼š1ï¼‰
3. âœ… åº”è¯¥è‡ªåŠ¨æ˜¾ç¤º TokenB çš„é¢„ä¼°æ•°é‡
4. âœ… ä¸åº”è¯¥æœ‰ä»»ä½•é”™è¯¯

## ğŸ“– å‚è€ƒèµ„æ–™

- [ethers.js v6 æ–‡æ¡£ - Contract Interaction](https://docs.ethers.org/v6/api/contract/)
- [ethers.js v6 è¿ç§»æŒ‡å—](https://docs.ethers.org/v6/migrating/)

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

### sqrtPriceLimitX96 å‚æ•°è¯´æ˜

`sqrtPriceLimitX96` æ˜¯ Uniswap V3 ç”¨äºé™åˆ¶äº¤æ˜“ä»·æ ¼æ»‘ç‚¹çš„å‚æ•°ï¼š

- **ä½œç”¨**: é™åˆ¶äº¤æ˜“æ‰§è¡Œçš„æœ€ç»ˆä»·æ ¼
- **æ ¼å¼**: Q64.96 æ ¼å¼çš„å®šç‚¹æ•°ï¼ˆ96 ä½å°æ•°ç²¾åº¦ï¼‰
- **èŒƒå›´**:
  - æœ€å°å€¼: `MIN_SQRT_PRICE = 4295128739`
  - æœ€å¤§å€¼: `MAX_SQRT_PRICE = 1461446703485210103287273052203988822378723970342`

### ä¸ºä»€ä¹ˆä¸èƒ½è®¾ç½®ä¸º 0ï¼Ÿ

åœ¨ Pool åˆçº¦ä¸­ï¼Œä»·æ ¼é™åˆ¶æ£€æŸ¥ä¼šéªŒè¯ï¼š

- ä» token0 åˆ° token1 (zeroForOne=true): `MIN_SQRT_PRICE < sqrtPriceLimitX96 < currentPrice`
- ä» token1 åˆ° token0 (zeroForOne=false): `currentPrice < sqrtPriceLimitX96 < MAX_SQRT_PRICE`

è®¾ç½®ä¸º 0 æ—¶ï¼Œè¿™äº›æ¡ä»¶éƒ½æ— æ³•æ»¡è¶³ï¼Œå¯¼è‡´ "SPL" é”™è¯¯ã€‚

### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ BigIntï¼Ÿ

`sqrtPriceLimitX96` æ˜¯ `uint160` ç±»å‹ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æ•´æ•°ã€‚JavaScript çš„ `Number` ç±»å‹æ— æ³•ç²¾ç¡®è¡¨ç¤ºè¿™ä¹ˆå¤§çš„æ•°å­—ï¼Œå¿…é¡»ä½¿ç”¨ `BigInt` ç±»å‹ï¼š

```typescript
// âŒ é”™è¯¯ï¼šå­—ç¬¦ä¸²ä¼šå¯¼è‡´ç±»å‹é”™è¯¯
const sqrtPriceLimitX96 = "4295128740"

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ BigInt
const sqrtPriceLimitX96 = BigInt("4295128740")
```

### æ­£ç¡®çš„åšæ³•

å½“ä¸æƒ³é™åˆ¶ä»·æ ¼æ—¶ï¼ˆæ¥å—ä»»ä½•æ»‘ç‚¹ï¼‰ï¼Œåº”è¯¥ä½¿ç”¨ï¼š

- zeroForOne=true: ä½¿ç”¨ `MIN_SQRT_PRICE + 1`
- zeroForOne=false: ä½¿ç”¨ `MAX_SQRT_PRICE - 1`

è¿™æ ·å¯ä»¥é€šè¿‡ä»·æ ¼æ£€æŸ¥ï¼ŒåŒæ—¶å®é™…ä¸Šä¸ä¼šé™åˆ¶äº¤æ˜“ã€‚

## âœ¨ æ€»ç»“

æ­¤æ¬¡ä¿®å¤è§£å†³äº† Swap æŠ¥ä»·åŠŸèƒ½çš„ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š

1. **ethers.js v6 è°ƒç”¨æ–¹å¼é—®é¢˜**

   - âœ… ä½¿ç”¨ `.staticCall` æ˜ç¡®åªè¯»è°ƒç”¨
   - âœ… é¿å…æ„å¤–å‘é€äº¤æ˜“

2. **ä»·æ ¼é™åˆ¶å‚æ•°é—®é¢˜**
   - âœ… æ­£ç¡®è®¡ç®— zeroForOne
   - âœ… è®¾ç½®åˆæ³•çš„ sqrtPriceLimitX96 å€¼
   - âœ… é€šè¿‡åˆçº¦çš„ä»·æ ¼æ£€æŸ¥

æœ€ç»ˆæ•ˆæœï¼š

- âœ… ç”¨æˆ·ä½“éªŒæµç•…ï¼Œè‡ªåŠ¨è·å–æŠ¥ä»·
- âœ… ä»£ç æ›´åŠ å¥å£®å’Œè§„èŒƒ
- âœ… ç¬¦åˆ ethers.js v6 å’Œ Uniswap V3 æœ€ä½³å®è·µ
- âœ… å®é™…äº¤æ˜“ä¹Ÿèƒ½æ­£å¸¸æ‰§è¡Œ
