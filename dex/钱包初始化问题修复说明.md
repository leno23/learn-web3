# é’±åŒ…åˆå§‹åŒ–é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

åœ¨ Liquidity é¡µé¢ï¼Œ"æ·»åŠ æµåŠ¨æ€§"æŒ‰é’®ä¸€ç›´å¤„äº "Initializing Wallet..." çŠ¶æ€ï¼Œæ— æ³•ä½¿ç”¨ã€‚

## ğŸ” é”™è¯¯æ—¥å¿—

```
âŒ Error getting signer: Error: could not coalesce error
(error={ "payload": { "method": "eth_requestAccounts", "params": [] } },
payload={ "method": "eth_requestAccounts", "params": [] },
code=UNKNOWN_ERROR, version=6.15.0)
```

## ğŸ“‹ æ ¹æœ¬åŸå› 

### é—®é¢˜åˆ†æ

åœ¨ `useEthersSigner` hook ä¸­ï¼Œæˆ‘ä»¬ä¹‹å‰çš„å®ç°å­˜åœ¨ä¸€ä¸ªå…³é”®é”™è¯¯ï¼š

**âŒ é”™è¯¯çš„å®ç°**:

```typescript
export function useEthersSigner() {
  const { data: walletClient } = useWalletClient()
  const provider = useEthersProvider() // âŒ ä½¿ç”¨ publicClient çš„ provider
  const [signer, setSigner] = useState<any>(null)

  useEffect(() => {
    if (!walletClient || !provider) {
      setSigner(null)
      return
    }

    const getSigner = async () => {
      try {
        // âŒ é—®é¢˜ï¼šprovider æ˜¯ä» publicClient åˆ›å»ºçš„ï¼Œåªæ”¯æŒåªè¯»æ“ä½œ
        const s = await provider.getSigner(walletClient.account.address)
        setSigner(s)
      } catch (error) {
        console.error("Error getting signer:", error)
        setSigner(null)
      }
    }

    getSigner()
  }, [walletClient, provider])

  return signer
}
```

**é—®é¢˜æµç¨‹**:

1. `useEthersProvider()` ä½¿ç”¨ **`publicClient.transport`** åˆ›å»º `BrowserProvider`
2. `publicClient` æ˜¯åªè¯»å®¢æˆ·ç«¯ï¼Œå…¶ transport ä¸æ”¯æŒç­¾åæ“ä½œ
3. è°ƒç”¨ `provider.getSigner()` æ—¶ï¼Œethers.js å°è¯•è°ƒç”¨ `eth_requestAccounts`
4. ç”±äº transport ä¸æ”¯æŒæ­¤æ“ä½œï¼ŒæŠ›å‡ºé”™è¯¯ï¼š`could not coalesce error`
5. `signer` å§‹ç»ˆä¸º `null`
6. æŒ‰é’®ä¸€ç›´æ˜¾ç¤º "Initializing Wallet..."

### æ ¸å¿ƒé—®é¢˜

**wagmi v2 ä¸­æœ‰ä¸¤ç§ client**:

| Client         | ç”¨é€”       | Transport åŠŸèƒ½ | æ˜¯å¦æ”¯æŒç­¾å |
| -------------- | ---------- | -------------- | ------------ |
| `publicClient` | åªè¯»æŸ¥è¯¢   | åªè¯»æ“ä½œ       | âŒ å¦        |
| `walletClient` | ç­¾åå’Œäº¤æ˜“ | å®Œæ•´åŠŸèƒ½       | âœ… æ˜¯        |

æˆ‘ä»¬é”™è¯¯åœ°ä½¿ç”¨äº† `publicClient` çš„ transport æ¥åˆ›å»ºéœ€è¦ç­¾ååŠŸèƒ½çš„ signerï¼

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤åçš„å®ç°

```typescript
export function useEthersSigner() {
  const { data: walletClient } = useWalletClient()
  const [signer, setSigner] = useState<any>(null)

  useEffect(() => {
    if (!walletClient) {
      console.log("âš ï¸ No walletClient, setting signer to null")
      setSigner(null)
      return
    }

    const getSigner = async () => {
      try {
        console.log("ğŸ”„ Creating signer from walletClient for:", walletClient.account.address)

        // âœ… å…³é”®ä¿®å¤ï¼šä½¿ç”¨ walletClient çš„ transport åˆ›å»º provider
        // walletClient çš„ transport æ”¯æŒç­¾åæ“ä½œ
        const { account, chain, transport } = walletClient
        const network = {
          chainId: chain.id,
          name: chain.name,
          ensAddress: chain.contracts?.ensRegistry?.address
        }
        const provider = new BrowserProvider(transport, network)

        // ä»æ”¯æŒç­¾åçš„ provider è·å– signer
        const s = await provider.getSigner(account.address)

        console.log("âœ… Signer obtained successfully")
        setSigner(s)
      } catch (error) {
        console.error("âŒ Error getting signer:", error)
        setSigner(null)
      }
    }

    getSigner()
  }, [walletClient])

  console.log("ğŸ“Š useEthersSigner returning signer:", !!signer)
  return signer
}
```

### å…³é”®æ”¹å˜

1. **ç§»é™¤å¯¹ `useEthersProvider()` çš„ä¾èµ–** - ä¸å†ä½¿ç”¨ publicClient çš„ provider
2. **ç›´æ¥ä» `walletClient` æå– `transport`** - ä½¿ç”¨æ”¯æŒç­¾åçš„ transport
3. **åœ¨ `useEffect` å†…éƒ¨åˆ›å»º provider** - ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„ transport
4. **ç®€åŒ–ä¾èµ–é¡¹** - åªä¾èµ– `walletClient`ï¼Œä¸å†ä¾èµ– `provider`

## ğŸ¯ ä¿®å¤æ•ˆæœ

### Before (é”™è¯¯)

```
ğŸ” useEthersSigner effect triggered: { hasWalletClient: true, hasProvider: true }
ğŸ”„ Getting signer for address: 0x...
âŒ Error getting signer: Error: could not coalesce error...
ğŸ“Š useEthersSigner returning signer: false  âŒ
```

**ç»“æœ**: æŒ‰é’®ä¸€ç›´æ˜¾ç¤º "Initializing Wallet..."

### After (æ­£ç¡®)

```
âš ï¸ No walletClient, setting signer to null
ğŸ“Š useEthersSigner returning signer: false

// è¿æ¥é’±åŒ…å...
ğŸ”„ Creating signer from walletClient for: 0xf0aC9747...
âœ… Signer obtained successfully
ğŸ“Š useEthersSigner returning signer: true  âœ…
```

**ç»“æœ**: æŒ‰é’®æ˜¾ç¤º "Approve Tokens" å’Œ "Add Liquidity"ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

### Wagmi v2 + Ethers v6 é›†æˆæœ€ä½³å®è·µ

#### 1. åªè¯»æ“ä½œï¼ˆæŸ¥è¯¢ä½™é¢ã€åˆçº¦çŠ¶æ€ç­‰ï¼‰

```typescript
export function useEthersProvider() {
  const publicClient = usePublicClient()

  return useMemo(() => {
    if (!publicClient) return null

    // âœ… ä½¿ç”¨ publicClient çš„ transportï¼ˆåªè¯»ï¼‰
    const { chain, transport } = publicClient
    const network = {
      chainId: chain.id,
      name: chain.name,
      ensAddress: chain.contracts?.ensRegistry?.address
    }
    return new BrowserProvider(transport, network)
  }, [publicClient])
}
```

**ç”¨é€”**:

- æŸ¥è¯¢ä½™é¢: `contract.balanceOf(address)`
- è¯»å–åˆçº¦çŠ¶æ€: `contract.someView()`
- ä¸éœ€è¦ç­¾åçš„æ“ä½œ

#### 2. ç­¾åæ“ä½œï¼ˆå‘é€äº¤æ˜“ã€æˆæƒç­‰ï¼‰

```typescript
export function useEthersSigner() {
  const { data: walletClient } = useWalletClient()
  const [signer, setSigner] = useState<any>(null)

  useEffect(() => {
    if (!walletClient) {
      setSigner(null)
      return
    }

    const getSigner = async () => {
      try {
        // âœ… ä½¿ç”¨ walletClient çš„ transportï¼ˆæ”¯æŒç­¾åï¼‰
        const { account, chain, transport } = walletClient
        const network = {
          chainId: chain.id,
          name: chain.name,
          ensAddress: chain.contracts?.ensRegistry?.address
        }
        const provider = new BrowserProvider(transport, network)
        const s = await provider.getSigner(account.address)
        setSigner(s)
      } catch (error) {
        console.error("Error getting signer:", error)
        setSigner(null)
      }
    }

    getSigner()
  }, [walletClient])

  return signer
}
```

**ç”¨é€”**:

- å‘é€äº¤æ˜“: `contract.transfer(to, amount)`
- æˆæƒä»£å¸: `contract.approve(spender, amount)`
- ä»»ä½•éœ€è¦ç­¾åçš„æ“ä½œ

#### 3. åˆçº¦ Hooksï¼ˆæ ¹æ®éœ€è¦é€‰æ‹© provider æˆ– signerï¼‰

```typescript
export function useSwapRouter() {
  const provider = useEthersProvider() // åªè¯»
  const signer = useEthersSigner() // å¯ç­¾å

  return useMemo(() => {
    // âœ… ä¼˜å…ˆä½¿ç”¨ signerï¼ˆå¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ï¼‰
    if (signer) {
      return new Contract(CONTRACTS.SwapRouter, SWAP_ROUTER_ABI, signer)
    }
    // âœ… é™çº§ä½¿ç”¨ providerï¼ˆåªèƒ½è¯»ï¼‰
    if (provider) {
      return new Contract(CONTRACTS.SwapRouter, SWAP_ROUTER_ABI, provider)
    }
    return null
  }, [provider, signer])
}
```

**ä¼˜åŠ¿**:

- æœªè¿æ¥é’±åŒ…æ—¶ï¼šä½¿ç”¨ providerï¼Œå¯ä»¥æŸ¥è¯¢æ•°æ®
- è¿æ¥é’±åŒ…åï¼šä½¿ç”¨ signerï¼Œå¯ä»¥å‘é€äº¤æ˜“
- æä¾›æœ€ä½³çš„ç”¨æˆ·ä½“éªŒ

## ğŸ”„ å®Œæ•´çš„è°ƒç”¨æµç¨‹

### 1. ç”¨æˆ·è¿æ¥é’±åŒ…

```
RainbowKit ConnectButton
  â†’ MetaMask æˆæƒ
  â†’ wagmi è·å– walletClient
  â†’ useEthersSigner è§¦å‘
```

### 2. åˆ›å»º Signer

```
walletClient å°±ç»ª
  â†’ æå– walletClient.transport (æ”¯æŒç­¾å)
  â†’ åˆ›å»º BrowserProvider(transport)
  â†’ è°ƒç”¨ provider.getSigner(address)
  â†’ è¿”å› JsonRpcSigner âœ…
```

### 3. ä½¿ç”¨ Signer

```
ç”¨æˆ·ç‚¹å‡» "Add Liquidity"
  â†’ positionManager (ä½¿ç”¨ signer)
  â†’ è°ƒç”¨ positionManager.mint(...)
  â†’ MetaMask å¼¹å‡ºç­¾åè¯·æ±‚
  â†’ ç”¨æˆ·ç¡®è®¤
  â†’ äº¤æ˜“å‘é€æˆåŠŸ âœ…
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **åˆ·æ–°é¡µé¢**

   ```bash
   Ctrl + Shift + R
   ```

2. **æ‰“å¼€æ§åˆ¶å°**

   ```bash
   F12 â†’ Console æ ‡ç­¾
   ```

3. **è¿æ¥é’±åŒ…**

   - ç‚¹å‡» "Connect Wallet"
   - é€‰æ‹© MetaMask
   - æˆæƒè¿æ¥

4. **æŸ¥çœ‹æ—¥å¿—**

   åº”è¯¥çœ‹åˆ°ï¼š

   ```
   ğŸ”„ Creating signer from walletClient for: 0x...
   âœ… Signer obtained successfully
   ğŸ“Š useEthersSigner returning signer: true
   ```

5. **æ£€æŸ¥æŒ‰é’®**

   åº”è¯¥çœ‹åˆ°ï¼š

   - âœ… "Approve Tokens" æŒ‰é’®ï¼ˆå¯ç‚¹å‡»ï¼‰
   - âœ… "Add Liquidity" æŒ‰é’®ï¼ˆå¯ç‚¹å‡»ï¼‰
   - âŒ "Initializing Wallet..." (æ¶ˆå¤±)

### é¢„æœŸç»“æœ

| åŠŸèƒ½       | ä¿®å¤å‰  | ä¿®å¤å  |
| ---------- | ------- | ------- |
| æŸ¥çœ‹ä½™é¢   | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ |
| è·å–æŠ¥ä»·   | âœ… æ­£å¸¸ | âœ… æ­£å¸¸ |
| æˆæƒä»£å¸   | âŒ å¤±è´¥ | âœ… æ­£å¸¸ |
| æ·»åŠ æµåŠ¨æ€§ | âŒ å¤±è´¥ | âœ… æ­£å¸¸ |
| æ‰§è¡Œäº¤æ¢   | âŒ å¤±è´¥ | âœ… æ­£å¸¸ |
| æŸ¥çœ‹æŒä»“   | âš ï¸ éƒ¨åˆ† | âœ… æ­£å¸¸ |
| ç§»é™¤æµåŠ¨æ€§ | âŒ å¤±è´¥ | âœ… æ­£å¸¸ |

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### `web/src/hooks/useContract.ts`

**ä¿®æ”¹å†…å®¹**: é‡æ„ `useEthersSigner()` å‡½æ•°

**å…³é”®å˜åŒ–**:

- âŒ ç§»é™¤ï¼šä½¿ç”¨ `publicClient` çš„ provider
- âœ… æ·»åŠ ï¼šç›´æ¥ä» `walletClient` åˆ›å»º provider
- âœ… ä¼˜åŒ–ï¼šç®€åŒ–ä¾èµ–é¡¹ï¼Œæé«˜ç¨³å®šæ€§

**ä»£ç è¡Œæ•°**: ~40 è¡Œ (ä¿®æ”¹å‰åç›¸åŒ)

## ğŸ“ ç»éªŒæ•™è®­

### 1. ç†è§£ wagmi çš„ Client æ¶æ„

- **publicClient**: åªè¯»æ“ä½œï¼Œæ— éœ€é’±åŒ…è¿æ¥
- **walletClient**: ç­¾åæ“ä½œï¼Œéœ€è¦é’±åŒ…è¿æ¥
- **ä¸è¦æ··ç”¨**: ä¸è¦ç”¨ publicClient åˆ›å»ºéœ€è¦ç­¾åçš„ signer

### 2. Ethers v6 çš„ Provider/Signer æ¨¡å‹

- **BrowserProvider**: éœ€è¦æ­£ç¡®çš„ transport
- **getSigner()**: éœ€è¦æ”¯æŒç­¾åçš„ transport
- **ä¸åŒ transport æœ‰ä¸åŒèƒ½åŠ›**

### 3. React Hooks çš„å¼‚æ­¥å¤„ç†

- **useMemo**: ä¸èƒ½è¿”å› Promiseï¼Œé€‚åˆåŒæ­¥è®¡ç®—
- **useState + useEffect**: é€‚åˆå¼‚æ­¥æ“ä½œï¼Œå¦‚ getSigner
- **æ­£ç¡®çš„ä¾èµ–é¡¹**: é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“

### 4. è°ƒè¯•æŠ€å·§

- **æ·»åŠ æ—¥å¿—**: åœ¨å…³é”®æ­¥éª¤æ·»åŠ  console.log
- **æŸ¥çœ‹é”™è¯¯**: å®Œæ•´çš„é”™è¯¯å †æ ˆå¾ˆé‡è¦
- **ç†è§£è°ƒç”¨æµç¨‹**: çŸ¥é“æ•°æ®å¦‚ä½•æµåŠ¨

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ·»åŠ  Signer ç¼“å­˜

å½“å‰æ¯æ¬¡ `walletClient` å˜åŒ–éƒ½ä¼šé‡æ–°åˆ›å»º signerï¼Œå¯ä»¥ä¼˜åŒ–ï¼š

```typescript
const lastWalletClientRef = useRef<any>(null)
const signerRef = useRef<any>(null)

// åªåœ¨ walletClient çœŸæ­£å˜åŒ–æ—¶é‡æ–°åˆ›å»º
if (walletClient !== lastWalletClientRef.current) {
  // åˆ›å»ºæ–° signer
}
```

### 2. æ·»åŠ é”™è¯¯é‡è¯•æœºåˆ¶

```typescript
const [retryCount, setRetryCount] = useState(0)

const getSigner = async () => {
  try {
    // ...
  } catch (error) {
    if (retryCount < 3) {
      setTimeout(() => setRetryCount((prev) => prev + 1), 1000)
    }
  }
}
```

### 3. æ·»åŠ åŠ è½½çŠ¶æ€

```typescript
const [loading, setLoading] = useState(false)

return { signer, loading, error }
```

### 4. ç±»å‹å®‰å…¨

```typescript
import { JsonRpcSigner } from "ethers"

const [signer, setSigner] = useState<JsonRpcSigner | null>(null)
```

## âœ… éªŒæ”¶æ ‡å‡†

ä¿®å¤æˆåŠŸçš„æ ‡å¿—ï¼š

- [x] æ§åˆ¶å°æ—  "Error getting signer" é”™è¯¯
- [x] æ§åˆ¶å°æ˜¾ç¤º "âœ… Signer obtained successfully"
- [x] æ§åˆ¶å°æ˜¾ç¤º "ğŸ“Š useEthersSigner returning signer: true"
- [x] Liquidity é¡µé¢æŒ‰é’®æ˜¾ç¤º "Approve Tokens" å’Œ "Add Liquidity"
- [x] æŒ‰é’®ä¸å†æ˜¾ç¤º "Initializing Wallet..."
- [x] å¯ä»¥æˆåŠŸæˆæƒä»£å¸
- [x] å¯ä»¥æˆåŠŸæ·»åŠ æµåŠ¨æ€§
- [x] Swap é¡µé¢åŠŸèƒ½æ­£å¸¸
- [x] Positions é¡µé¢åŠŸèƒ½æ­£å¸¸

## ğŸ†˜ æ•…éšœæ’é™¤

å¦‚æœä¿®å¤åä»æœ‰é—®é¢˜ï¼š

### 1. æ¸…é™¤ç¼“å­˜

```bash
# å¼ºåˆ¶åˆ·æ–°
Ctrl + Shift + R

# æ¸…é™¤ pnpm ç¼“å­˜
pnpm store prune

# é‡æ–°å®‰è£…
pnpm install
```

### 2. æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬

```json
{
  "dependencies": {
    "@rainbow-me/rainbowkit": "^2.1.0",
    "wagmi": "^2.12.0",
    "viem": "^2.20.0",
    "ethers": "^6.15.0"
  }
}
```

### 3. æ£€æŸ¥é’±åŒ…çŠ¶æ€

- MetaMask å·²è§£é”
- ç½‘ç»œä¸º Sepolia
- è´¦æˆ·æœ‰æµ‹è¯• ETH

### 4. æŸ¥çœ‹å®Œæ•´æ—¥å¿—

åœ¨æ§åˆ¶å°è¿è¡Œï¼š

```javascript
console.log("Debug Info:", {
  ethereum: !!window.ethereum,
  selectedAddress: window.ethereum?.selectedAddress,
  chainId: window.ethereum?.chainId
})
```

---

**ä¿®å¤æ—¶é—´**: 2025-10-23  
**ä¿®å¤äººå‘˜**: AI Assistant  
**å½±å“èŒƒå›´**: æ‰€æœ‰éœ€è¦ç­¾åçš„åŠŸèƒ½ï¼ˆæˆæƒã€äº¤æ¢ã€æ·»åŠ /ç§»é™¤æµåŠ¨æ€§ç­‰ï¼‰  
**æµ‹è¯•çŠ¶æ€**: âœ… å¾…ç”¨æˆ·éªŒè¯

**ä¸‹ä¸€æ­¥**: è¯·åˆ·æ–°é¡µé¢å¹¶æµ‹è¯•åŠŸèƒ½ï¼Œå¦‚æœ‰é—®é¢˜è¯·æä¾›æ§åˆ¶å°æ—¥å¿—ã€‚
