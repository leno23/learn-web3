# 交易错误修复总结

## 📋 问题列表

### 1. ✅ 余额查询错误

**错误信息**:

```
Error: could not coalesce error
code=UNKNOWN_ERROR
```

**原因**: `useEthersSigner()` 在 `useMemo` 中返回 async 函数，导致返回 Promise 而不是 signer

**解决**: 改用 `useState` + `useEffect` 处理异步操作

---

### 2. ✅ 添加流动性错误

**错误信息**:

```
Error: contract runner does not support sending transactions
code=UNSUPPORTED_OPERATION
```

**原因**: 合约使用 provider（只读）而不是 signer（可写）创建

**解决**: 优先使用 signer，移除 isConnected 检查

---

## 🔧 核心修复

### useEthersSigner Hook

```typescript
// ✅ 正确实现
export function useEthersSigner() {
  const { data: walletClient } = useWalletClient()
  const provider = useEthersProvider()
  const [signer, setSigner] = useState<any>(null)

  useEffect(() => {
    if (!walletClient || !provider) {
      setSigner(null)
      return
    }

    const getSigner = async () => {
      try {
        const s = await provider.getSigner(walletClient.account.address)
        setSigner(s)
      } catch (error) {
        console.error("Error getting signer:", error)
        setSigner(null)
      }
    }

    getSigner()
  }, [walletClient, provider])

  return signer // 直接返回 signer，不是 Promise
}
```

### 合约 Hooks

```typescript
// ✅ 优先使用 signer
export function usePositionManager() {
  const provider = useEthersProvider()
  const signer = useEthersSigner()

  return useMemo(() => {
    // 1. 优先使用 signer（可以发送交易）
    if (signer) {
      return new Contract(CONTRACTS.PositionManager, POSITION_MANAGER_ABI, signer)
    }
    // 2. 降级使用 provider（只读）
    if (provider) {
      return new Contract(CONTRACTS.PositionManager, POSITION_MANAGER_ABI, provider)
    }
    // 3. 都没有返回 null
    return null
  }, [provider, signer])
}
```

## 📊 对比表

| 场景       | Provider  | Signer  |
| ---------- | --------- | ------- |
| 读取数据   | ✅ 可以   | ✅ 可以 |
| 查询余额   | ✅ 可以   | ✅ 可以 |
| 发送交易   | ❌ 不可以 | ✅ 可以 |
| 授权代币   | ❌ 不可以 | ✅ 可以 |
| 交换代币   | ❌ 不可以 | ✅ 可以 |
| 添加流动性 | ❌ 不可以 | ✅ 可以 |

## ✨ 改进点

### 1. 更好的错误处理

```typescript
try {
  await contract.mint(...);
} catch (error: any) {
  let errorMessage = error.message;

  // 友好的错误提示
  if (error.message.includes('UNSUPPORTED_OPERATION')) {
    errorMessage = 'Please make sure your wallet is connected and unlocked.';
  } else if (error.message.includes('user rejected')) {
    errorMessage = 'Transaction was rejected.';
  }

  alert(`Transaction failed: ${errorMessage}`);
}
```

### 2. 更完善的检查

```typescript
const handleTransaction = async () => {
  // 1. 检查钱包连接
  if (!isConnected) {
    alert('Please connect wallet first');
    return;
  }

  // 2. 检查合约是否准备好
  if (!contract) {
    alert('Contract not found. Please wait a moment and try again.');
    return;
  }

  // 3. 执行交易
  try {
    const tx = await contract.someMethod(...);
    await tx.wait();
    alert('Success!');
  } catch (error) {
    // 错误处理
  }
};
```

## 🎯 使用建议

### 等待合约准备好

由于 signer 是异步获取的，可能需要等待：

```typescript
// ❌ 可能会失败
const contract = useContract()
await contract.mint() // contract 可能是 null 或使用 provider

// ✅ 添加检查
const contract = useContract()
if (!contract) {
  alert("Please wait for contract to be ready")
  return
}
await contract.mint() // 安全
```

### 连接钱包后等待

```typescript
// 连接钱包
await connect({ connector: injectedConnector })

// 等待一下让 signer 准备好
setTimeout(() => {
  // 现在可以安全使用合约
}, 1000)
```

## 📝 修改文件

1. ✅ `web/src/hooks/useContract.ts`

   - 修复 `useEthersSigner()`
   - 优化所有合约 hooks

2. ✅ `web/src/components/Swap.tsx`

   - 添加连接检查
   - 改进错误提示

3. ✅ `web/src/components/Liquidity.tsx`

   - 添加连接检查
   - 改进错误提示

4. ✅ `web/src/components/Positions.tsx`
   - 优化合约使用

## 🧪 测试检查

确保以下功能正常：

- [x] 连接钱包
- [x] 查看 ETH 余额
- [x] 查看代币余额
- [x] 授权代币
- [x] 交换代币
- [x] 添加流动性
- [x] 移除流动性
- [x] 提取手续费

## 🚀 最佳实践

1. **异步操作使用 useEffect + useState**

   - 不要在 useMemo 中返回 Promise
   - 使用 useState 缓存异步结果

2. **优先使用 signer**

   - signer 可以读取也可以写入
   - provider 只能读取

3. **完善的错误处理**

   - 检查参数
   - 检查连接状态
   - 友好的错误提示

4. **等待合约准备**
   - 检查 contract 不为 null
   - 提示用户等待

---

**修复完成时间**: 2025-10-22  
**所有功能状态**: ✅ 正常工作
