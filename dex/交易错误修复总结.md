# äº¤æ˜“é”™è¯¯ä¿®å¤æ€»ç»“

## ğŸ“‹ é—®é¢˜åˆ—è¡¨

### 1. âœ… ä½™é¢æŸ¥è¯¢é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:

```
Error: could not coalesce error
code=UNKNOWN_ERROR
```

**åŸå› **: `useEthersSigner()` åœ¨ `useMemo` ä¸­è¿”å› async å‡½æ•°ï¼Œå¯¼è‡´è¿”å› Promise è€Œä¸æ˜¯ signer

**è§£å†³**: æ”¹ç”¨ `useState` + `useEffect` å¤„ç†å¼‚æ­¥æ“ä½œ

---

### 2. âœ… æ·»åŠ æµåŠ¨æ€§é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:

```
Error: contract runner does not support sending transactions
code=UNSUPPORTED_OPERATION
```

**åŸå› **: åˆçº¦ä½¿ç”¨ providerï¼ˆåªè¯»ï¼‰è€Œä¸æ˜¯ signerï¼ˆå¯å†™ï¼‰åˆ›å»º

**è§£å†³**: ä¼˜å…ˆä½¿ç”¨ signerï¼Œç§»é™¤ isConnected æ£€æŸ¥

---

## ğŸ”§ æ ¸å¿ƒä¿®å¤

### useEthersSigner Hook

```typescript
// âœ… æ­£ç¡®å®ç°
export function useEthersSigner() {
  const { data: walletClient } = useWalletClient()
  const provider = useEthersProvider()
  const [signer, setSigner] = useState<any>(null)

  useEffect(() => {
    if (!walletClient || !provider) {
      setSigner(null)
      return
    }

    const getSigner = async () => {
      try {
        const s = await provider.getSigner(walletClient.account.address)
        setSigner(s)
      } catch (error) {
        console.error("Error getting signer:", error)
        setSigner(null)
      }
    }

    getSigner()
  }, [walletClient, provider])

  return signer // ç›´æ¥è¿”å› signerï¼Œä¸æ˜¯ Promise
}
```

### åˆçº¦ Hooks

```typescript
// âœ… ä¼˜å…ˆä½¿ç”¨ signer
export function usePositionManager() {
  const provider = useEthersProvider()
  const signer = useEthersSigner()

  return useMemo(() => {
    // 1. ä¼˜å…ˆä½¿ç”¨ signerï¼ˆå¯ä»¥å‘é€äº¤æ˜“ï¼‰
    if (signer) {
      return new Contract(CONTRACTS.PositionManager, POSITION_MANAGER_ABI, signer)
    }
    // 2. é™çº§ä½¿ç”¨ providerï¼ˆåªè¯»ï¼‰
    if (provider) {
      return new Contract(CONTRACTS.PositionManager, POSITION_MANAGER_ABI, provider)
    }
    // 3. éƒ½æ²¡æœ‰è¿”å› null
    return null
  }, [provider, signer])
}
```

## ğŸ“Š å¯¹æ¯”è¡¨

| åœºæ™¯       | Provider  | Signer  |
| ---------- | --------- | ------- |
| è¯»å–æ•°æ®   | âœ… å¯ä»¥   | âœ… å¯ä»¥ |
| æŸ¥è¯¢ä½™é¢   | âœ… å¯ä»¥   | âœ… å¯ä»¥ |
| å‘é€äº¤æ˜“   | âŒ ä¸å¯ä»¥ | âœ… å¯ä»¥ |
| æˆæƒä»£å¸   | âŒ ä¸å¯ä»¥ | âœ… å¯ä»¥ |
| äº¤æ¢ä»£å¸   | âŒ ä¸å¯ä»¥ | âœ… å¯ä»¥ |
| æ·»åŠ æµåŠ¨æ€§ | âŒ ä¸å¯ä»¥ | âœ… å¯ä»¥ |

## âœ¨ æ”¹è¿›ç‚¹

### 1. æ›´å¥½çš„é”™è¯¯å¤„ç†

```typescript
try {
  await contract.mint(...);
} catch (error: any) {
  let errorMessage = error.message;

  // å‹å¥½çš„é”™è¯¯æç¤º
  if (error.message.includes('UNSUPPORTED_OPERATION')) {
    errorMessage = 'Please make sure your wallet is connected and unlocked.';
  } else if (error.message.includes('user rejected')) {
    errorMessage = 'Transaction was rejected.';
  }

  alert(`Transaction failed: ${errorMessage}`);
}
```

### 2. æ›´å®Œå–„çš„æ£€æŸ¥

```typescript
const handleTransaction = async () => {
  // 1. æ£€æŸ¥é’±åŒ…è¿æ¥
  if (!isConnected) {
    alert('Please connect wallet first');
    return;
  }

  // 2. æ£€æŸ¥åˆçº¦æ˜¯å¦å‡†å¤‡å¥½
  if (!contract) {
    alert('Contract not found. Please wait a moment and try again.');
    return;
  }

  // 3. æ‰§è¡Œäº¤æ˜“
  try {
    const tx = await contract.someMethod(...);
    await tx.wait();
    alert('Success!');
  } catch (error) {
    // é”™è¯¯å¤„ç†
  }
};
```

## ğŸ¯ ä½¿ç”¨å»ºè®®

### ç­‰å¾…åˆçº¦å‡†å¤‡å¥½

ç”±äº signer æ˜¯å¼‚æ­¥è·å–çš„ï¼Œå¯èƒ½éœ€è¦ç­‰å¾…ï¼š

```typescript
// âŒ å¯èƒ½ä¼šå¤±è´¥
const contract = useContract()
await contract.mint() // contract å¯èƒ½æ˜¯ null æˆ–ä½¿ç”¨ provider

// âœ… æ·»åŠ æ£€æŸ¥
const contract = useContract()
if (!contract) {
  alert("Please wait for contract to be ready")
  return
}
await contract.mint() // å®‰å…¨
```

### è¿æ¥é’±åŒ…åç­‰å¾…

```typescript
// è¿æ¥é’±åŒ…
await connect({ connector: injectedConnector })

// ç­‰å¾…ä¸€ä¸‹è®© signer å‡†å¤‡å¥½
setTimeout(() => {
  // ç°åœ¨å¯ä»¥å®‰å…¨ä½¿ç”¨åˆçº¦
}, 1000)
```

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

1. âœ… `web/src/hooks/useContract.ts`

   - ä¿®å¤ `useEthersSigner()`
   - ä¼˜åŒ–æ‰€æœ‰åˆçº¦ hooks

2. âœ… `web/src/components/Swap.tsx`

   - æ·»åŠ è¿æ¥æ£€æŸ¥
   - æ”¹è¿›é”™è¯¯æç¤º

3. âœ… `web/src/components/Liquidity.tsx`

   - æ·»åŠ è¿æ¥æ£€æŸ¥
   - æ”¹è¿›é”™è¯¯æç¤º

4. âœ… `web/src/components/Positions.tsx`
   - ä¼˜åŒ–åˆçº¦ä½¿ç”¨

## ğŸ§ª æµ‹è¯•æ£€æŸ¥

ç¡®ä¿ä»¥ä¸‹åŠŸèƒ½æ­£å¸¸ï¼š

- [x] è¿æ¥é’±åŒ…
- [x] æŸ¥çœ‹ ETH ä½™é¢
- [x] æŸ¥çœ‹ä»£å¸ä½™é¢
- [x] æˆæƒä»£å¸
- [x] äº¤æ¢ä»£å¸
- [x] æ·»åŠ æµåŠ¨æ€§
- [x] ç§»é™¤æµåŠ¨æ€§
- [x] æå–æ‰‹ç»­è´¹

## ğŸš€ æœ€ä½³å®è·µ

1. **å¼‚æ­¥æ“ä½œä½¿ç”¨ useEffect + useState**

   - ä¸è¦åœ¨ useMemo ä¸­è¿”å› Promise
   - ä½¿ç”¨ useState ç¼“å­˜å¼‚æ­¥ç»“æœ

2. **ä¼˜å…ˆä½¿ç”¨ signer**

   - signer å¯ä»¥è¯»å–ä¹Ÿå¯ä»¥å†™å…¥
   - provider åªèƒ½è¯»å–

3. **å®Œå–„çš„é”™è¯¯å¤„ç†**

   - æ£€æŸ¥å‚æ•°
   - æ£€æŸ¥è¿æ¥çŠ¶æ€
   - å‹å¥½çš„é”™è¯¯æç¤º

4. **ç­‰å¾…åˆçº¦å‡†å¤‡**
   - æ£€æŸ¥ contract ä¸ä¸º null
   - æç¤ºç”¨æˆ·ç­‰å¾…

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-22  
**æ‰€æœ‰åŠŸèƒ½çŠ¶æ€**: âœ… æ­£å¸¸å·¥ä½œ
