# 钱包初始化问题排查指南

## 🐛 问题现象

在 Liquidity 页面，"添加流动性"按钮一直处于 "Initializing Wallet..." 状态，无法使用。

## 🔍 问题原因

按钮显示 "Initializing Wallet..." 说明 `signer` 对象始终为 `null`，这通常由以下原因导致：

1. **钱包未正确连接** - RainbowKit ConnectButton 显示已连接，但实际上 `walletClient` 未正确获取
2. **Provider 未就绪** - `publicClient` 或 `provider` 未正确初始化
3. **getSigner 调用失败** - 从 provider 获取 signer 时出错
4. **Wagmi 配置问题** - 配置不当导致钱包客户端无法正常工作

## 🛠️ 排查步骤

### 步骤 1: 检查浏览器控制台

1. 按 `F12` 打开开发者工具
2. 切换到 "Console" (控制台) 标签
3. 查看是否有以下调试信息：

```
🔍 useEthersSigner effect triggered: {
  hasWalletClient: true/false,
  hasProvider: true/false,
  walletAddress: "0x..."
}
```

**根据输出判断问题：**

#### 情况 A: `hasWalletClient: false`

**问题**: 钱包客户端未获取

**解决方案**:

1. 确保已通过 RainbowKit 连接钱包
2. 检查 MetaMask 是否已解锁
3. 尝试断开并重新连接钱包
4. 刷新页面后重新连接

#### 情况 B: `hasProvider: false`

**问题**: Provider 未初始化

**解决方案**:

1. 检查网络连接
2. 确认已切换到 Sepolia 测试网
3. 检查浏览器是否安装了钱包插件
4. 重启浏览器

#### 情况 C: `hasWalletClient: true, hasProvider: true` 但无后续日志

**问题**: `getSigner` 调用失败

**解决方案**:

1. 查看控制台是否有错误信息：`❌ Error getting signer:`
2. 检查错误详细信息
3. 可能需要更新 MetaMask 或其他钱包插件
4. 尝试切换到其他钱包

### 步骤 2: 检查 Liquidity 页面状态

在控制台查看：

```
💡 Liquidity Page - Wallet Status: {
  isConnected: true/false,
  address: "0x..." / undefined,
  hasPositionManager: true/false,
  hasSigner: true/false,
  isSignerReady: true/false
}
```

**期望的正常状态**:

```
{
  isConnected: true,
  address: "0x1234...",
  hasPositionManager: true,
  hasSigner: true,
  isSignerReady: true
}
```

### 步骤 3: 验证 Wagmi 配置

检查 `web/src/config/wagmi.ts` 文件：

```typescript
import { getDefaultConfig } from "@rainbow-me/rainbowkit"
import { sepolia } from "wagmi/chains"

export const config = getDefaultConfig({
  appName: "MetaNodeSwap",
  projectId: "e01cebcfbc5e8353d1736bfc6293918b", // 确保这个 ID 有效
  chains: [sepolia],
  ssr: false
})
```

**检查项**:

- ✅ `projectId` 不为空
- ✅ `chains` 包含 `sepolia`
- ✅ `ssr` 设置为 `false`

### 步骤 4: 验证 Provider 结构

在 `web/src/hooks/useContract.ts` 中，检查 `useEthersProvider`:

```typescript
export function useEthersProvider() {
  const publicClient = usePublicClient()

  return useMemo(() => {
    if (!publicClient) return null
    const { chain, transport } = publicClient
    const network = {
      chainId: chain.id,
      name: chain.name,
      ensAddress: chain.contracts?.ensRegistry?.address
    }
    return new BrowserProvider(transport, network)
  }, [publicClient])
}
```

**在控制台手动测试**:

```javascript
// 检查 publicClient
console.log("Public Client:", window.wagmi?.publicClient)

// 检查连接状态
console.log("Connection:", {
  address: window.ethereum?.selectedAddress,
  chainId: window.ethereum?.chainId
})
```

## 🔧 常见解决方案

### 解决方案 1: 刷新并重新连接

最简单也最有效的方法：

1. 按 `Ctrl + Shift + R` 强制刷新页面
2. 点击 RainbowKit 的 "Connect Wallet" 按钮
3. 选择钱包并连接
4. 等待几秒钟，观察按钮状态

### 解决方案 2: 清除缓存和重新安装依赖

如果刷新无效：

```bash
# 停止开发服务器 (Ctrl + C)

# 清除 node_modules
rm -rf node_modules

# 清除 pnpm 缓存
pnpm store prune

# 重新安装
pnpm install

# 重启开发服务器
pnpm dev
```

### 解决方案 3: 检查 MetaMask 设置

1. 打开 MetaMask
2. 确保已解锁
3. 确保当前账户有余额（即使是 0 也行）
4. 确保网络为 "Sepolia Test Network"
5. 在 MetaMask 设置中，找到 "连接的网站"
6. 如果看到 `localhost:3000`，尝试断开并重新连接
7. 如果没有看到，说明未正确连接

### 解决方案 4: 尝试其他钱包

如果 MetaMask 有问题，尝试使用其他钱包：

1. 点击 RainbowKit "Connect Wallet" 按钮
2. 选择 "Coinbase Wallet" 或其他可用钱包
3. 按照提示完成连接

### 解决方案 5: 更新依赖版本

检查 `package.json` 中的版本：

```json
{
  "dependencies": {
    "@rainbow-me/rainbowkit": "^2.1.0",
    "wagmi": "^2.12.0",
    "viem": "^2.20.0",
    "ethers": "^6.15.0"
  }
}
```

如果版本不匹配，更新：

```bash
pnpm update @rainbow-me/rainbowkit wagmi viem ethers
```

## 🐞 调试技巧

### 添加更多日志

在 `useEthersProvider` 中添加日志：

```typescript
export function useEthersProvider() {
  const publicClient = usePublicClient()

  return useMemo(() => {
    console.log("🔍 useEthersProvider:", {
      hasPublicClient: !!publicClient,
      chain: publicClient?.chain?.name,
      chainId: publicClient?.chain?.id
    })

    if (!publicClient) return null
    const { chain, transport } = publicClient
    const network = {
      chainId: chain.id,
      name: chain.name,
      ensAddress: chain.contracts?.ensRegistry?.address
    }
    const provider = new BrowserProvider(transport, network)
    console.log("✅ Provider created:", provider)
    return provider
  }, [publicClient])
}
```

### 手动测试 getSigner

在控制台中测试：

```javascript
// 1. 检查 ethereum 对象
console.log("Ethereum:", window.ethereum)

// 2. 请求账户
window.ethereum
  .request({ method: "eth_requestAccounts" })
  .then((accounts) => console.log("Accounts:", accounts))
  .catch((err) => console.error("Error:", err))

// 3. 检查 chainId
window.ethereum
  .request({ method: "eth_chainId" })
  .then((chainId) => console.log("Chain ID:", chainId))
  .catch((err) => console.error("Error:", err))
```

## ✅ 验证修复

修复后，应该看到以下日志序列：

```
1. 🔍 useEthersProvider: {
     hasPublicClient: true,
     chain: "Sepolia",
     chainId: 11155111
   }

2. ✅ Provider created: BrowserProvider {...}

3. 🔍 useEthersSigner effect triggered: {
     hasWalletClient: true,
     hasProvider: true,
     walletAddress: "0x..."
   }

4. 🔄 Getting signer for address: 0x...

5. ✅ Signer obtained successfully

6. 📊 useEthersSigner returning signer: true

7. 💡 Liquidity Page - Wallet Status: {
     isConnected: true,
     address: "0x...",
     hasPositionManager: true,
     hasSigner: true,
     isSignerReady: true
   }
```

此时，按钮应该从 "Initializing Wallet..." 变为可用状态（显示 "Approve Tokens" 和 "Add Liquidity"）。

## 🆘 仍然无法解决？

如果以上方法都无效，请提供以下信息：

1. **浏览器控制台完整日志** (截图或复制)
2. **使用的钱包** (MetaMask 版本号等)
3. **浏览器版本** (Chrome / Firefox / Edge)
4. **操作系统** (Windows / macOS / Linux)
5. **package.json 中的依赖版本**

**调试命令**:

```javascript
// 在浏览器控制台运行
console.log("Debug Info:", {
  ethereum: !!window.ethereum,
  selectedAddress: window.ethereum?.selectedAddress,
  chainId: window.ethereum?.chainId,
  isConnected: window.ethereum?.isConnected?.(),
  wagmi: !!window.wagmi
})
```

将输出结果一起提供，以便进一步诊断。

## 📝 已知问题

### Issue #1: React Strict Mode 导致重复渲染

**现象**: 在开发模式下，组件可能渲染两次，导致 signer 获取延迟

**解决方案**: 这是正常的开发模式行为，生产环境不受影响。如需测试，可以暂时移除 `main.tsx` 中的 `<React.StrictMode>`

### Issue #2: Wagmi Hooks 缓存问题

**现象**: 切换账户后，signer 未及时更新

**解决方案**: 刷新页面或在代码中添加账户切换监听

```typescript
useEffect(() => {
  // 账户切换时重置 signer
  return () => {
    setSigner(null)
  }
}, [address])
```

### Issue #3: RainbowKit Modal 未关闭

**现象**: 连接成功但 Modal 仍打开，导致 walletClient 未更新

**解决方案**: 点击 Modal 外部关闭，或添加自动关闭逻辑

---

**最后更新**: 2025-10-23  
**适用版本**:

- RainbowKit: ^2.1.0
- Wagmi: ^2.12.0
- Ethers: ^6.15.0
