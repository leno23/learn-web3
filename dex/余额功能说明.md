# Swap 页面余额功能说明

## ✨ 新增功能

### 1. 实时余额显示

Swap 页面现在可以**实时查询和显示**当前连接账号的代币余额。

#### 功能特点

✅ **ETH 余额显示**
- 在页面右上角显示当前账户的 ETH 余额
- 智能格式化：大数字显示为 K/M 单位
- 鼠标悬停可查看完整数值

✅ **代币余额显示**
- 每个代币输入框下方显示该代币的余额
- 格式化显示，易于阅读
- 鼠标悬停显示完整的 18 位精度余额

✅ **智能格式化**
```typescript
0         → "0"
0.00001   → "<0.0001"
0.1234    → "0.1234"
123.45    → "123.45"
12,345    → "12.35K"
1,234,567 → "1.23M"
```

### 2. MAX 按钮

快速设置最大可交换数量。

**使用方法**：
- 点击 "From" 输入框旁边的 **MAX** 按钮
- 自动填充该代币的全部余额
- 余额为 0 时按钮禁用

### 3. 刷新余额按钮

手动刷新所有余额。

**使用方法**：
- 点击右上角的 **🔄** 按钮
- 同时刷新 ETH 余额和所有代币余额
- 交易完成后会自动刷新

### 4. 余额自动刷新

余额会在以下情况自动刷新：
- ✅ 连接钱包时
- ✅ 切换账户时
- ✅ 切换代币时
- ✅ 交易成功后

## 🎨 界面设计

### 页面布局

```
┌───────────────────────────────────────────────┐
│  Swap               💰 1.5 ETH    🔄          │
├───────────────────────────────────────────────┤
│  Fee Tier                                     │
│  [0.05%]  [0.30%✓]  [1.00%]                  │
├───────────────────────────────────────────────┤
│  From                               [MAX]     │
│  [输入框]                [MNTokenA ▼]        │
│  Balance: 1,250.50 MNTokenA                   │
├───────────────────────────────────────────────┤
│                      ⇅                        │
├───────────────────────────────────────────────┤
│  To (estimated)                               │
│  [输出框]                [MNTokenB ▼]        │
│  Balance: 500.25 MNTokenB                     │
└───────────────────────────────────────────────┘
```

### 样式特点

**ETH 余额显示**
- 深色背景卡片
- 金钱图标 💰
- 格式化数值 + 单位

**刷新按钮**
- 圆形按钮
- 刷新图标 🔄
- 悬停时旋转 180°

**MAX 按钮**
- 紫色渐变背景
- 小巧的标签样式
- 悬停时放大效果

**代币余额**
- 灰色辅助文字
- 加粗显示数值
- 工具提示显示完整精度

## 💻 技术实现

### 新增 Hook

#### `useEthBalance.ts`
获取 ETH 余额的自定义 Hook

```typescript
const { balance, loading, refetch } = useEthBalance();

// balance: 格式化的余额字符串
// loading: 加载状态
// refetch: 手动刷新函数
```

#### 改进 `useTokenBalance.ts`
添加了 `refetch` 方法

```typescript
const { balance, loading, refetch } = useTokenBalance(tokenAddress);

// refetch: 手动刷新余额
```

### 余额格式化函数

```typescript
const formatBalance = (balance: string): string => {
  const num = parseFloat(balance);
  if (num === 0) return '0';
  if (num < 0.0001) return '<0.0001';
  if (num < 1) return num.toFixed(4);
  if (num < 1000) return num.toFixed(2);
  if (num < 1000000) return (num / 1000).toFixed(2) + 'K';
  return (num / 1000000).toFixed(2) + 'M';
};
```

### 刷新逻辑

```typescript
// 刷新所有余额
const refreshBalances = () => {
  refetchBalanceIn();   // 刷新输入代币余额
  refetchBalanceOut();  // 刷新输出代币余额
  refetchEthBalance();  // 刷新 ETH 余额
};

// 交易成功后自动刷新
await tx.wait();
refreshBalances();
```

## 📱 用户体验

### 实时反馈

用户可以：
1. 随时查看账户 ETH 余额
2. 查看每个代币的可用余额
3. 快速设置最大交换数量
4. 手动刷新获取最新余额
5. 鼠标悬停查看精确余额

### 智能提示

- 余额不足时可以及时发现
- 工具提示显示完整数值
- 格式化显示提高可读性
- 自动刷新保证数据准确

## 🎯 使用示例

### 场景 1: 查看余额

1. 连接钱包
2. 右上角显示 ETH 余额：**💰 1.5 ETH**
3. 输入框下方显示代币余额：**Balance: 1,250.50 MNTokenA**
4. 鼠标悬停查看完整精度

### 场景 2: 使用 MAX 按钮

1. 想要交换所有 MNTokenA
2. 点击 **MAX** 按钮
3. 输入框自动填充：**1250.50**
4. 查看预期输出

### 场景 3: 刷新余额

1. 在其他地方进行了转账
2. 点击右上角 **🔄** 按钮
3. 所有余额更新为最新值

### 场景 4: 交易后自动更新

1. 完成一笔交换
2. 系统自动刷新余额
3. 显示交易后的新余额

## 🔧 配置说明

### 余额刷新时机

余额会在以下时机自动刷新：

```typescript
useEffect(() => {
  fetchBalance();
}, [
  address,        // 账户地址变化时
  isConnected,    // 连接状态变化时
  tokenAddress    // 代币地址变化时
]);
```

### 精度设置

- **显示精度**: 根据数值大小自动调整
- **存储精度**: 18 位小数 (标准 ERC20)
- **工具提示**: 显示 18 位完整精度

## 📊 性能优化

1. **防抖处理**: 避免频繁请求
2. **条件刷新**: 只在必要时刷新
3. **缓存结果**: 使用 React state 缓存
4. **异步加载**: 不阻塞 UI 渲染

## ⚠️ 注意事项

1. **余额刷新**
   - 区块链数据有延迟
   - 交易确认后需要等待
   - 可手动点击刷新按钮

2. **MAX 按钮**
   - 使用全部余额可能导致 Gas 费不足
   - 建议留一些 ETH 用于 Gas

3. **余额显示**
   - 格式化显示可能四舍五入
   - 悬停查看完整精度
   - 实际交易使用完整精度

## 🎨 样式类名

```css
.card-header          /* 卡片头部 */
.balance-info         /* 余额信息容器 */
.eth-balance          /* ETH 余额显示 */
.refresh-balance-button  /* 刷新按钮 */
.label-row            /* 标签行 */
.max-button           /* MAX 按钮 */
.balance              /* 代币余额 */
.balance strong       /* 余额数值 */
```

---

## 总结

通过这些新增功能，用户可以：

✅ 实时查看账户 ETH 和代币余额  
✅ 快速使用 MAX 按钮设置最大金额  
✅ 手动刷新获取最新余额  
✅ 享受自动刷新的便利  
✅ 查看智能格式化的余额显示  
✅ 鼠标悬停查看完整精度  

这极大地提升了用户体验，让交易更加便捷和直观！🎉

