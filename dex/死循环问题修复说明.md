# æ­»å¾ªç¯é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜åˆ†æ

### é—®é¢˜ç°è±¡

æ§åˆ¶å°ä¸æ–­æ‰“å°ï¼š

```
Already fetching balance, skipping...
Already fetching balance, skipping...
Already fetching balance, skipping...
...æ— é™å¾ªç¯
```

### æ ¹æœ¬åŸå› 

**ä¾èµ–é“¾å¼ååº”å¯¼è‡´çš„æ— é™å¾ªç¯**ï¼š

```
1. useTokenContract æ¯æ¬¡åˆ›å»ºæ–°çš„ Contract å®ä¾‹
   â†“
2. tokenContract å¼•ç”¨æ”¹å˜
   â†“
3. fetchBalance çš„ useCallback ä¾èµ– tokenContract â†’ é‡æ–°åˆ›å»º
   â†“
4. fetchBalance æ”¹å˜
   â†“
5. useEffect ä¾èµ– fetchBalance â†’ è§¦å‘
   â†“
6. è°ƒç”¨ fetchBalance
   â†“
7. çŠ¶æ€å¯èƒ½æ›´æ–° â†’ é‡æ–°æ¸²æŸ“
   â†“
8. å›åˆ°æ­¥éª¤ 1 â†’ â™»ï¸ æ­»å¾ªç¯ï¼
```

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: useTokenContract æ·»åŠ ç¼“å­˜æœºåˆ¶

**é—®é¢˜**: æ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°çš„ Contract å®ä¾‹

**è§£å†³**: ä½¿ç”¨ `useRef` ç¼“å­˜åˆçº¦å®ä¾‹

```typescript
// web/src/hooks/useContract.ts

export function useTokenContract(tokenAddress: string | null) {
  const provider = useEthersProvider()
  const signer = useEthersSigner()
  const contractRef = useRef<any>(null)
  const lastTokenRef = useRef<string | null>(null)
  const lastSignerRef = useRef<any>(null)

  return useMemo(() => {
    if (!tokenAddress) return null

    // âœ… å¦‚æœ token åœ°å€å’Œ signer éƒ½æ²¡å˜ï¼Œè¿”å›ç¼“å­˜çš„åˆçº¦
    if (contractRef.current && lastTokenRef.current === tokenAddress && lastSignerRef.current === signer) {
      return contractRef.current // è¿”å›ç¼“å­˜ï¼Œä¸åˆ›å»ºæ–°å®ä¾‹
    }

    // åªæœ‰åœ¨çœŸæ­£éœ€è¦æ—¶æ‰åˆ›å»ºæ–°å®ä¾‹
    if (signer) {
      const contract = new Contract(tokenAddress, ERC20_ABI, signer)
      contractRef.current = contract
      lastTokenRef.current = tokenAddress
      lastSignerRef.current = signer
      return contract
    }

    if (provider) {
      const contract = new Contract(tokenAddress, ERC20_ABI, provider)
      contractRef.current = contract
      lastTokenRef.current = tokenAddress
      lastSignerRef.current = null
      return contract
    }

    return null
  }, [tokenAddress, provider, signer])
}
```

### ä¿®å¤ 2: useTokenBalance ä½¿ç”¨ useRef é¿å…ä¾èµ–å¯¹è±¡

**é—®é¢˜**: useEffect ä¾èµ– `fetchBalance` å’Œ `tokenContract`ï¼Œå¯¼è‡´å¾ªç¯è§¦å‘

**è§£å†³**: ä½¿ç”¨ `useRef` ä¿å­˜ `tokenContract`ï¼Œ`useCallback` åªä¾èµ–åŸºæœ¬ç±»å‹

```typescript
// web/src/hooks/useTokenBalance.ts

// ä½¿ç”¨ useRef ä¿å­˜æœ€æ–°çš„ tokenContract
const tokenContractRef = useRef(tokenContract)
tokenContractRef.current = tokenContract

// âœ… fetchBalance åªä¾èµ–åŸºæœ¬ç±»å‹ï¼Œä¸ä¾èµ–å¯¹è±¡
const fetchBalance = useCallback(async () => {
  if (!isConnected || !address || !tokenAddress) {
    setBalance("0")
    return
  }

  // ä» ref ä¸­è·å–æœ€æ–°çš„ contractï¼Œé¿å…ä½œä¸ºä¾èµ–
  const contract = tokenContractRef.current
  if (!contract) {
    return
  }

  // ... æ‰§è¡Œ balanceOf ...
}, [isConnected, address, tokenAddress]) // âœ… åªä¾èµ–åŸºæœ¬ç±»å‹
```

### ä¿®å¤ 3: Swap.tsx å’Œ Liquidity.tsx é¿å…ä¾èµ– refetch å‡½æ•°

**é—®é¢˜**: ç»„ä»¶çš„ `useEffect` ä¾èµ– `refetchBalance` å‡½æ•°ï¼Œå¯¼è‡´å¾ªç¯è§¦å‘

**è§£å†³**: ä½¿ç”¨ `useRef` ä¿å­˜ refetch å‡½æ•°å¼•ç”¨

```typescript
// web/src/components/Swap.tsx

// ä½¿ç”¨ useRef ä¿å­˜ refetch å‡½æ•°ï¼Œé¿å…ä¾èµ–é—®é¢˜
const refetchBalanceInRef = useRef(refetchBalanceIn)
refetchBalanceInRef.current = refetchBalanceIn

// âœ… å½“ä»£å¸åˆ‡æ¢æ—¶å¼ºåˆ¶åˆ·æ–°ä½™é¢ï¼ˆä¸ä¾èµ– refetch å‡½æ•°ï¼‰
useEffect(() => {
  // ä½¿ç”¨ ref è®¿é—®æœ€æ–°çš„ refetch å‡½æ•°
  refetchBalanceInRef.current()
  refetchBalanceOutRef.current()
}, [tokenIn.address, tokenOut.address]) // âœ… åªä¾èµ–åœ°å€ï¼Œä¸ä¾èµ–å‡½æ•°
```

### ä¿®å¤ 4: æ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—

```typescript
// è·Ÿè¸ªæ¸²æŸ“æ¬¡æ•°
const renderCountRef = useRef(0)
renderCountRef.current += 1

useEffect(() => {
  console.log(`ğŸ“Š [useTokenBalance] Render #${renderCountRef.current}`, {
    tokenAddress,
    address: address?.slice(0, 10),
    isConnected,
    hasContract: !!tokenContract
  })
})

// Effect è§¦å‘æ—¥å¿—
useEffect(() => {
  console.log("ğŸ”„ [useTokenBalance] Fetching balance...")
  fetchBalance()
}, [address, isConnected, tokenAddress])
```

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆæ­»å¾ªç¯ï¼‰

```
[useTokenBalance] Render #1
ğŸ“ Created new token contract with signer for 0x4798...
[useTokenBalance] Effect triggered
ğŸ”„ Fetching balance...
[useTokenBalance] Render #2
ğŸ“ Created new token contract with signer for 0x4798... â† åˆåˆ›å»ºäº†ï¼
[useTokenBalance] Effect triggered â† åˆè§¦å‘äº†ï¼
ğŸ”„ Fetching balance...
Already fetching balance, skipping...
[useTokenBalance] Render #3
ğŸ“ Created new token contract with signer for 0x4798... â† ç»§ç»­åˆ›å»ºï¼
[useTokenBalance] Effect triggered â† ç»§ç»­è§¦å‘ï¼
Already fetching balance, skipping... â† æ­»å¾ªç¯ï¼
...æ— é™å¾ªç¯
```

### ä¿®å¤åï¼ˆæ­£å¸¸ï¼‰

```
[useTokenBalance] Render #1
ğŸ“ Created new token contract with signer for 0x4798...
[useTokenBalance] Effect triggered
ğŸ”„ Fetching balance...
âœ… Balance fetched for 0x4798...: 1250.50

[useTokenBalance] Render #2
âœ… ä½¿ç”¨ç¼“å­˜çš„åˆçº¦ï¼Œä¸å†åˆ›å»ºæ–°å®ä¾‹
âœ… Effect ä¸å†è§¦å‘ï¼Œå› ä¸ºä¾èµ–æ²¡å˜

âœ… åªæ‰§è¡Œä¸€æ¬¡ï¼Œä¸ä¼šå¾ªç¯ï¼
```

## ğŸ¯ å…³é”®è¦ç‚¹

### 1. React Hooks ä¾èµ–è§„åˆ™

- `useMemo` / `useCallback` / `useEffect` çš„ä¾èµ–æ•°ç»„å¿…é¡»åŒ…å«æ‰€æœ‰ä½¿ç”¨çš„å¤–éƒ¨å˜é‡
- ä½†æ˜¯ï¼Œè¿‡å¤šçš„ä¾èµ–ä¼šå¯¼è‡´å¾ªç¯è§¦å‘
- è§£å†³æ–¹æ¡ˆï¼š
  - âœ… ç¼“å­˜ä¸å˜çš„å¯¹è±¡ï¼ˆuseRefï¼‰
  - âœ… åªä¾èµ–çœŸæ­£éœ€è¦å“åº”çš„å€¼
  - âœ… åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨é—­åŒ…è®¿é—®æœ€æ–°å€¼

### 2. å¯¹è±¡å¼•ç”¨ç¨³å®šæ€§

```typescript
// âŒ æ¯æ¬¡éƒ½æ˜¯æ–°å¯¹è±¡ï¼Œå¼•ç”¨ä¸åŒ
const contract = new Contract(address, abi, signer)

// âœ… ä½¿ç”¨ useRef ç¼“å­˜ï¼Œå¼•ç”¨ç¨³å®š
const contractRef = useRef(null)
if (!contractRef.current) {
  contractRef.current = new Contract(address, abi, signer)
}
```

### 3. è°ƒè¯•æŠ€å·§

```typescript
// æ·»åŠ æ¸²æŸ“è®¡æ•°å™¨
const renderCount = useRef(0)
renderCount.current += 1
console.log("Render #", renderCount.current)

// è·Ÿè¸ªä¾èµ–å˜åŒ–
useEffect(() => {
  console.log("Dependency changed:", { dep1, dep2, dep3 })
}, [dep1, dep2, dep3])
```

## ğŸ” å¦‚ä½•éªŒè¯ä¿®å¤

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œä½ åº”è¯¥çœ‹åˆ°ï¼š

### æ­£å¸¸æƒ…å†µï¼š

```
ğŸ“Š [useTokenBalance] Render #1 { tokenAddress: "0x4798...", ... }
ğŸ“ Created new token contract with signer for 0x4798...
ğŸ”„ [useTokenBalance] Fetching balance...
âœ… Balance fetched for 0x4798...: 1250.50

âœ… åªæœ‰åˆå§‹åŒ–æ—¶æ‰§è¡Œä¸€æ¬¡
âœ… åˆ‡æ¢ä»£å¸æ—¶æ‰ä¼šé‡æ–°æ‰§è¡Œ
```

### å¼‚å¸¸æƒ…å†µï¼ˆéœ€è¦æ£€æŸ¥ï¼‰ï¼š

```
âŒ Render è®¡æ•°å™¨ä¸æ–­å¢åŠ  (#1, #2, #3, ...)
âŒ ä¸æ–­åˆ›å»ºæ–°åˆçº¦ (Created new token contract...)
âŒ ä¸æ–­æ‰“å° "Already fetching balance, skipping..."
```

## âœ… æµ‹è¯•æ¸…å•

- [ ] é¡µé¢åŠ è½½åï¼Œä½™é¢åªè·å–ä¸€æ¬¡
- [ ] æ§åˆ¶å°æ²¡æœ‰ "Already fetching balance, skipping..." å¾ªç¯æ—¥å¿—
- [ ] åˆ‡æ¢ä»£å¸æ—¶ï¼Œä¼šé‡æ–°è·å–ä½™é¢ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰
- [ ] ç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼Œæ‰‹åŠ¨åˆ·æ–°ä½™é¢æ­£å¸¸
- [ ] Render è®¡æ•°å™¨ä¸ä¼šæ— é™å¢é•¿

## ğŸ“ åç»­ä¼˜åŒ–

å¦‚æœè°ƒè¯•æ—¥å¿—å¤ªå¤šï¼Œå¯ä»¥åœ¨ç¨³å®šåç§»é™¤ï¼š

```typescript
// ç§»é™¤è¿™äº›è°ƒè¯•æ—¥å¿—ï¼š
useEffect(() => {
  console.log(`[useTokenBalance] Render #${renderCountRef.current}`, ...);
});

console.log('ğŸ“Š [useTokenBalance] Effect triggered', ...);
console.log('ğŸ”„ [useTokenBalance] Fetching balance...');
```

ä¿ç•™è¿™äº›æœ‰ç”¨çš„æ—¥å¿—ï¼š

```typescript
console.log(`âœ… Balance fetched for ${tokenAddress}: ${balance}`)
console.log("âŒ Error fetching balance:", error)
console.log("ğŸ“ Created new token contract with signer for ...")
```

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-23  
**é—®é¢˜ç±»å‹**: React Hooks ä¾èµ–å¾ªç¯  
**ä¿®å¤éš¾åº¦**: â­â­â­â­ (ä¸­é«˜)
